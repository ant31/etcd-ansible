# Introduction to This Repository

## What is etcd-ansible?

This is an **Ansible repository** that automates deploying and managing etcd clusters. It contains Ansible roles, playbooks, and configurations to handle the entire lifecycle of etcd clusters with Smallstep CA certificate management.

## Repository Contents

### Ansible Roles Structure

```
roles/etcd3/
├── cluster/              # Main cluster lifecycle role
│   ├── install/          # Deploys etcd via meta dependencies
│   ├── delete/           # Removes cluster
│   ├── meta/main.yml     # Role dependencies
│   └── tasks/main.yaml   # Orchestrates create/upgrade/backup/delete
├── certs/smallstep/      # Smallstep CA automation
│   ├── tasks/
│   │   ├── install-ca.yml         # Setup step-ca on cert-manager
│   │   ├── install-client.yml     # Install step CLI on nodes
│   │   └── configure-renewal.yml  # Create renewal timers
│   ├── templates/
│   │   ├── step-ca.service.j2     # step-ca systemd service
│   │   ├── step-renew.service.j2  # Certificate renewal service
│   │   └── step-renew.timer.j2    # Renewal timer config
│   └── defaults/main.yml          # Certificate configuration
├── facts/                # Generates etcd cluster facts
│   └── tasks/main.yaml   # Creates etcd_members, etcd_access_addresses
├── backups/              # Snapshot creation
│   └── tasks/main.yaml   # Creates etcd snapshots
├── backups/cron/         # Automated backup scheduling
│   ├── tasks/
│   │   ├── setup-ca-backup-cron.yml
│   │   └── setup-etcd-backup-cron.yml
│   └── templates/
│       ├── ca-backup-check.sh.j2
│       └── etcd-backup.sh.j2
├── restore/              # Disaster recovery
│   └── tasks/
│       ├── restore-ca.yml
│       └── restore-etcd.yml
└── download/             # Binary downloads
    └── tasks/main.yml    # Downloads etcd, step-ca, step CLI
```

### Playbooks

```
playbooks/
├── backup-ca.yaml              # Backup CA keys (encrypted)
├── restore-ca.yaml             # Restore from backup node
├── restore-ca-from-backup.yaml # Restore from S3
├── restore-etcd-cluster.yaml   # Restore etcd data
├── replicate-ca.yaml           # Replicate CA to backups
└── setup-kms.yaml              # Create AWS KMS key

etcd.yaml                       # Main entry point playbook
```

## How This Repository Works

### Required Inventory Groups

**YOU MUST DEFINE THESE THREE GROUPS:**

#### 1. `[etcd]` - Cluster Member Nodes
```ini
[etcd]
etcd-k8s-1 ansible_host=10.0.1.10
etcd-k8s-2 ansible_host=10.0.1.11
etcd-k8s-3 ansible_host=10.0.1.12
```
Nodes where etcd service will run. Odd number required (3, 5, 7).

#### 2. `[etcd-cert-managers]` - CA Key Holders
```ini
[etcd-cert-managers]
etcd-k8s-1  # step-ca runs here
etcd-k8s-2  # backup (CA keys replicated)
```
**CRITICAL:** Nodes that hold CA private keys and run step-ca.
- MUST be subset of `[etcd]` group
- First node: step-ca service runs here
- Others: CA keys replicated for failover

#### 3. `[etcd-clients]` - Client Certificate Recipients (Optional)
```ini
[etcd-clients]
kube-apiserver-1 ansible_host=10.0.2.10
```
Nodes that need client certs but don't run etcd.

### Ansible Role Dependencies

The `roles/etcd3/cluster/install/meta/main.yml` defines what runs:

```yaml
dependencies:
  - etcd3                    # Loads defaults
  - adduser                  # Creates etcd user
  - etcd3/facts              # Generates cluster variables
  - etcd3/certs/smallstep    # ← INSTALLS STEP-CA & CERTS
  - etcd3/download           # Downloads binaries
  - etcd3/backups/cron       # Configures automated backups
```

When you run `etcd.yaml`, it imports `etcd3/cluster` which triggers all these dependencies.

### How Variables Flow

1. **Defaults** defined in `roles/etcd3/defaults/main.yaml`
2. **Secrets** encrypted in `group_vars/all/vault.yml`
3. **Facts** generated by `roles/etcd3/facts/` (etcd_members, etcd_access_addresses)
4. **Templates** use these vars:
   - `roles/etcd3/cluster/install/templates/etcd-conf.yaml.j2`
   - `roles/etcd3/certs/smallstep/templates/step-ca.service.j2`
   - `roles/etcd3/backups/cron/templates/etcd-backup.sh.j2`

### How Playbooks Work

**`etcd.yaml` (main playbook):**
```yaml
- hosts: etcd                    # ← Uses [etcd] inventory group
  tasks:
    - import_role:
        name: etcd3/cluster      # ← Triggers everything
      vars:
        etcd_cluster_name: k8s
```

**`playbooks/restore-etcd-cluster.yaml`:**
```yaml
- hosts: etcd                    # ← Targets all etcd nodes
  roles:
    - etcd3/restore              # ← Uses restore role
      vars:
        restore_etcd_data: true
```

## Ansible Variables You Control

### Action Variable (controls what happens)
```bash
# Deploy new cluster
-e etcd_action=create

# Upgrade existing cluster
-e etcd_action=upgrade

# Backup cluster
-e etcd_action=backup

# Delete cluster
-e etcd_delete_cluster=true
```

### Essential Variables
- `etcd_cluster_name` - Cluster identifier (default: "default")
- `etcd_version` - Which etcd version to install
- `etcd_certmanagers_group` - Inventory group name (default: "etcd-cert-managers")

### Certificate Variables (in `roles/etcd3/certs/smallstep/defaults/main.yml`)
- `step_ca_port: 9000` - Port for step-ca service
- `step_cert_default_duration: "17520h"` - Certificate lifetime (2 years)
- `step_ca_password` - CA password (store in vault.yml)

### Backup Variables (in `roles/etcd3/backups/cron/defaults/main.yml`)
- `etcd_backup_cron_enabled: true` - Enable automated backups
- `etcd_backup_interval: "*/30"` - Backup frequency
- `backup_healthcheck_url` - Monitoring endpoint

## Architecture Overview

### Single Cluster

```
┌─────────────────────────────────────────────────────────┐
│ Cert-Manager Node (etcd-k8s-1)                          │
│ - etcd cluster member                                   │
│ - step-ca service (port 9000)                           │
│ - CA keys in /etc/step-ca/secrets/                      │
└─────────────────────────────────────────────────────────┘
                         │
                         │ HTTPS
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
    ┌────────┐      ┌────────┐      ┌────────┐
    │etcd-k8s-2│    │etcd-k8s-3│    │ clients │
    │+ step CLI│    │+ step CLI│    │+ step CLI│
    └────────┘      └────────┘      └────────┘
```

### High Availability Setup

```
┌─────────────────────────────────────────────────────────┐
│ Primary Cert-Manager (etcd-k8s-1)                       │
│ - step-ca RUNNING                                       │
│ - CA keys active                                        │
└─────────────────────────────────────────────────────────┘
                         │
                         │ CA key replication
                         ▼
┌─────────────────────────────────────────────────────────┐
│ Backup Cert-Manager (etcd-k8s-2)                        │
│ - step-ca STOPPED (ready for failover)                  │
│ - CA keys replicated                                    │
└─────────────────────────────────────────────────────────┘
```

## How It Works

### 1. Initial Deployment

```bash
ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=create
```

This single command:

1. Sets up step-ca on cert-manager node
2. Initializes CA with root and intermediate certificates
3. Installs step CLI on all nodes
4. Generates certificates for all nodes (2-year lifetime)
5. Configures automatic renewal (at 2/3 of lifetime)
6. Deploys etcd cluster
7. Configures automated backups

### 2. Certificate Management

Certificates are automatically managed throughout their lifecycle:

1. **Issuance**: Nodes request certificates from step-ca
2. **Storage**: Private keys stored locally (never transmitted)
3. **Renewal**: Systemd timers renew at ~487 days (for 2-year certs)
4. **Rotation**: Zero-downtime reload of etcd after renewal

### 3. Backup & Recovery

- **Automated Backups**: 
  - CA backups when changed
  - Etcd data backups every 30 minutes (configurable)
  - Encrypted with AWS KMS
  - Uploaded to S3 with retention policy

- **Disaster Recovery**:
  - Simple playbooks for restoration
  - Multiple recovery scenarios supported
  - Detailed runbooks included

## Supported Platforms

### Operating Systems

- Ubuntu 20.04+
- Debian 11+
- RHEL 8+
- CentOS 8+
- Rocky Linux 8+
- CoreOS (stable)

### Etcd Versions

- v3.5.x (recommended)
- v3.6.x (latest)

### Requirements

- **Ansible**: 2.9 or later
- **Python**: 3.6 or later on all nodes
- **AWS CLI**: For S3 backups and KMS encryption
- **Network**: 
  - Port 2379 (client)
  - Port 2380 (peer)
  - Port 9000 (step-ca)

## Comparison with Alternatives

| Feature | etcd-ansible | Manual Setup | cfssl | cert-manager (K8s) |
|---------|-------------|--------------|-------|-------------------|
| Automated Deployment | ✅ | ❌ | ⚠️ Partial | ✅ |
| Certificate Automation | ✅ | ❌ | ❌ | ✅ |
| Auto Renewal | ✅ | ❌ | ❌ | ✅ |
| Backup Automation | ✅ | ❌ | ❌ | ⚠️ Partial |
| Disaster Recovery | ✅ | ⚠️ Manual | ⚠️ Manual | ⚠️ Partial |
| Non-Kubernetes | ✅ | ✅ | ✅ | ❌ |
| Production Ready | ✅ | ⚠️ Complex | ⚠️ Complex | ✅ |
| Learning Curve | Low | High | Medium | Medium |

## Use Cases

### 1. Kubernetes etcd Backend

Deploy dedicated etcd clusters for Kubernetes control plane:

```ini
[etcd]
k8s-etcd-1 ansible_host=10.0.1.10
k8s-etcd-2 ansible_host=10.0.1.11
k8s-etcd-3 ansible_host=10.0.1.12

[etcd-clients]
k8s-master-1 ansible_host=10.0.2.10
k8s-master-2 ansible_host=10.0.2.11
k8s-master-3 ansible_host=10.0.2.12
```

### 2. Application Configuration Store

Centralized configuration management for distributed applications:

```ini
[etcd]
config-etcd-1 ansible_host=10.0.3.10
config-etcd-2 ansible_host=10.0.3.11
config-etcd-3 ansible_host=10.0.3.12

[etcd-clients]
app-server-1 ansible_host=10.0.4.10
app-server-2 ansible_host=10.0.4.11
```

### 3. Service Discovery

etcd as service registry for microservices:

```ini
[etcd]
discovery-etcd-1 ansible_host=10.0.5.10
discovery-etcd-2 ansible_host=10.0.5.11
discovery-etcd-3 ansible_host=10.0.5.12

[etcd-clients]
service-mesh-nodes ansible_host=10.0.6.[10:50]
```

### 4. Multi-Cluster Setup

Separate clusters for different purposes:

- Primary cluster for main data
- Events cluster for event streaming
- Configuration cluster for settings

## Getting Started

Ready to deploy your first cluster? Continue to:

- [Prerequisites](prerequisites.md) - System requirements and preparation
- [Quick Start](quick-start.md) - Deploy your first cluster in 15 minutes
- [Installation Guide](../installation/deployment.md) - Detailed deployment instructions

## Next Steps

Once you're familiar with the basics:

1. [Inventory Setup](../installation/inventory.md) - Configure your inventory
2. [AWS KMS Setup](../installation/kms-setup.md) - Configure encrypted backups
3. [Operations Guide](../operations/cluster-management.md) - Day-2 operations
4. [Certificate Management](../certificates/overview.md) - Deep dive into certificates
