# Smallstep Certificate Workflow - Architecture and Security

**NOTE: This document describes the CURRENT implementation using Smallstep CA.**
**The old cfssl-based CSR workflow was replaced with Smallstep in commit f03de18.**

## Overview

This project uses **Smallstep CA (step-ca)** for automated certificate management. This is a modern, industry-standard approach that eliminates manual certificate distribution and provides automatic renewal.

## Critical Concepts

### 1. Step-CA Runs on Cert-Manager Node

**WRONG Understanding:**
- ❌ Step-CA is a separate dedicated server
- ❌ Step-CA runs on your laptop/Ansible controller
- ❌ Need a special machine just for the CA

**CORRECT Understanding:**
- ✅ step-ca runs on the cert-manager node (typically first etcd node)
- ✅ It's a regular etcd node that ALSO runs the step-ca service
- ✅ step-ca listens on port 9000 (HTTPS)
- ✅ CA root and intermediate keys stored in `/etc/step-ca/secrets/`

### 2. Nodes Request Certificates Directly from Step-CA

**WRONG Understanding:**
- ❌ Ansible generates certificates and distributes them
- ❌ Certificates are created in tarballs and copied around
- ❌ Nodes receive pre-generated certificates

**CORRECT Understanding:**
- ✅ Each node uses `step ca certificate` command to request certs from step-ca
- ✅ step-ca generates the certificate and private key pair
- ✅ Private key is created locally on the requesting node
- ✅ Certificate is signed by step-ca and returned to the node
- ✅ NO manual CSR creation or signing needed

### 3. Private Keys NEVER Leave Their Node

**WRONG Understanding:**
- ❌ Private keys are generated centrally and distributed
- ❌ Ansible holds private keys during deployment
- ❌ Private keys are in tarballs or archives

**CORRECT Understanding:**
- ✅ Private keys generated by step CLI on each node during cert request
- ✅ Private keys stored in `/etc/etcd/ssl/` on each node (mode 0400)
- ✅ Private keys NEVER transmitted over network
- ✅ Only the signed certificate (public data) comes from step-ca

### 4. Automatic Certificate Renewal

**Key Features:**
- ✅ Systemd timers automatically renew certificates
- ✅ Renewal happens at 2/3 of certificate lifetime (~487 days for 2-year certs)
- ✅ Zero-downtime renewal (etcd reloaded, not restarted)
- ✅ No manual intervention required

---

## Smallstep Architecture

```
┌─────────────────────────────────────────────────────────┐
│ etcd-k8s-1 (Cert-Manager Node)                          │
│ - Runs etcd                                             │
│ - Runs step-ca on port 9000                             │
│ - CA keys in /etc/step-ca/secrets/                      │
│                                                          │
│   ┌─────────────────────────────────────────────────┐  │
│   │ step-ca Service                                 │  │
│   │ - root_ca.crt (public)                          │  │
│   │ - root_ca.key (private - NEVER leaves)          │  │
│   │ - intermediate_ca.crt (public)                  │  │
│   │ - intermediate_ca.key (private - NEVER leaves)  │  │
│   │ - Database of issued certificates               │  │
│   └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                         ▲
                         │ HTTPS port 9000
                         │ Certificate requests
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ etcd-k8s-2   │  │ etcd-k8s-3   │  │ app-server   │
│              │  │              │  │ (client)     │
│ step CLI     │  │ step CLI     │  │              │
│ + systemd    │  │ + systemd    │  │ step CLI     │
│   timers     │  │   timers     │  │ + systemd    │
│              │  │              │  │   timer      │
│ Requests:    │  │ Requests:    │  │              │
│ - peer cert  │  │ - peer cert  │  │ Requests:    │
│ - server cert│  │ - server cert│  │ - client cert│
│ - client cert│  │ - client cert│  │              │
└──────────────┘  └──────────────┘  └──────────────┘

Each node stores:
/etc/etcd/ssl/
  ├── etcd-k8s-X-peer.key     (private - generated locally)
  ├── etcd-k8s-X-peer.crt     (signed by step-ca)
  ├── etcd-k8s-X-server.key   (private - generated locally)
  ├── etcd-k8s-X-server.crt   (signed by step-ca)
  ├── etcd-k8s-X-client.key   (private - generated locally)
  ├── etcd-k8s-X-client.crt   (signed by step-ca)
  └── root_ca.crt             (public - from step-ca)
```

### Example Cluster
```
etcd-k8s-1: 10.0.1.10  (etcd + step-ca)
etcd-k8s-2: 10.0.1.11  (etcd only)
etcd-k8s-3: 10.0.1.12  (etcd only)
app-server: 10.0.2.50  (client)
```

### Inventory File
```ini
[etcd]
etcd-k8s-1 ansible_host=10.0.1.10
etcd-k8s-2 ansible_host=10.0.1.11
etcd-k8s-3 ansible_host=10.0.1.12

[etcd-clients]
app-server ansible_host=10.0.2.50

[etcd-cert-managers]
etcd-k8s-1  # This etcd node will hold the CA keys
```

---

## Deployment Workflow

### Phase 1: Initialize step-ca on Cert-Manager Node

Command (from your laptop):
```bash
ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=create
```

What happens on **etcd-k8s-1**:

```
┌─────────────────────────────────────────────────────────┐
│ etcd-k8s-1 (Cert-Manager Node)                          │
│                                                          │
│ 1. Download and install step-ca + step CLI:             │
│    - /opt/bin/step-ca                                   │
│    - /opt/bin/step                                      │
│                                                          │
│ 2. Initialize step-ca:                                  │
│    step ca init \                                       │
│      --name="etcd-default-ca" \                         │
│      --dns="etcd-k8s-1.local" \                         │
│      --address=":9000" \                                │
│      --provisioner="etcd-provisioner"                   │
│                                                          │
│    Creates in /etc/step-ca/:                            │
│    ├── config/ca.json (CA configuration)                │
│    ├── certs/root_ca.crt (root CA cert - public)       │
│    ├── secrets/root_ca_key (root CA key - PRIVATE)     │
│    ├── certs/intermediate_ca.crt (intermediate - public)│
│    ├── secrets/intermediate_ca_key (intermediate - PRIV)│
│    └── db/ (certificate database)                       │
│                                                          │
│ 3. Configure certificate lifetimes:                     │
│    - Default: 2 years (17520h)                          │
│    - Max: 3 years (26280h)                              │
│    - Min: 1 hour                                        │
│                                                          │
│ 4. Start step-ca systemd service:                       │
│    systemctl enable --now step-ca                       │
│    (Listens on https://etcd-k8s-1:9000)                 │
└─────────────────────────────────────────────────────────┘
```

**Result:**
- ✅ step-ca running on etcd-k8s-1:9000
- ✅ CA keys in `/etc/step-ca/secrets/` (mode 0400, owner root)
- ✅ CA keys NEVER leave etcd-k8s-1
- ✅ Ready to issue certificates

### Phase 2: Install step CLI and Request Certificates on Each Node

What happens on **etcd-k8s-2** (and etcd-k8s-3):

```
┌─────────────────────────────────────────────────────────┐
│ etcd-k8s-2 (Regular etcd node)                          │
│                                                          │
│ 1. Install step CLI:                                    │
│    - Download and install /opt/bin/step                 │
│                                                          │
│ 2. Install root CA certificate:                         │
│    - Copy root_ca.crt from step-ca                      │
│    - Store in /etc/etcd/ssl/root_ca.crt                 │
│                                                          │
│ 3. Bootstrap step CLI:                                  │
│    step ca bootstrap \                                  │
│      --ca-url https://etcd-k8s-1:9000 \                 │
│      --fingerprint <root-ca-fingerprint> \              │
│      --install                                          │
│    (Configures step CLI to trust step-ca)               │
│                                                          │
│ 4. Request peer certificate:                            │
│    step ca certificate "etcd-k8s-2" \                   │
│      /etc/etcd/ssl/etcd-k8s-2-peer.crt \                │
│      /etc/etcd/ssl/etcd-k8s-2-peer.key \                │
│      --provisioner="etcd-provisioner" \                 │
│      --ca-url="https://etcd-k8s-1:9000" \               │
│      --san="10.0.1.11" \                                │
│      --san="etcd-k8s-2.local" \                         │
│      --not-after="17520h"                               │
│                                                          │
│    This single command:                                 │
│    - Generates private key ON etcd-k8s-2                │
│    - Sends cert request to step-ca via HTTPS            │
│    - Receives signed certificate from step-ca           │
│    - Saves both key and cert locally                    │
│                                                          │
│ 5. Request server certificate (similar):                │
│    step ca certificate "etcd-k8s-2-server" ...          │
│                                                          │
│ 6. Request client certificate (similar):                │
│    step ca certificate "etcd-k8s-2-client" ...          │
│                                                          │
│ 7. Create symlinks for compatibility:                   │
│    ln -s root_ca.crt peer-ca.crt                        │
│    ln -s root_ca.crt client-ca.crt                      │
│                                                          │
│ 8. Set permissions:                                     │
│    chmod 0400 *.key  (private keys)                     │
│    chmod 0644 *.crt  (certificates)                     │
└─────────────────────────────────────────────────────────┘
```

**Key Points:**
- ✅ Private keys generated locally by `step ca certificate` command
- ✅ Private keys NEVER transmitted (created and stay on etcd-k8s-2)
- ✅ Only HTTPS communication with step-ca (encrypted)
- ✅ No CSR files, no manual signing - step CLI handles everything

### Phase 3: Configure Automatic Certificate Renewal

What happens on **all etcd nodes**:

```
┌─────────────────────────────────────────────────────────┐
│ Each etcd node (etcd-k8s-1, etcd-k8s-2, etcd-k8s-3)     │
│                                                          │
│ 1. Create systemd renewal services:                     │
│    /etc/systemd/system/step-renew-etcd-k8s-X-peer.service│
│    /etc/systemd/system/step-renew-etcd-k8s-X-server.service│
│    /etc/systemd/system/step-renew-etcd-k8s-X-client.service│
│                                                          │
│    Each service runs:                                   │
│    step ca renew --force \                              │
│      /etc/etcd/ssl/etcd-k8s-X-peer.crt \                │
│      /etc/etcd/ssl/etcd-k8s-X-peer.key                  │
│                                                          │
│ 2. Create systemd timers:                               │
│    /etc/systemd/system/step-renew-etcd-k8s-X-peer.timer │
│    (Runs daily at 3:00 AM with 1h random delay)         │
│                                                          │
│ 3. Enable and start timers:                             │
│    systemctl enable --now step-renew-*.timer             │
│                                                          │
│ 4. Renewal triggers when < 1/3 lifetime remains:        │
│    - 2-year cert (17520h total)                         │
│    - Renews at ~487 days (11688h)                       │
│    - Gives ~243 days warning before expiration          │
│                                                          │
│ 5. After renewal, reload etcd:                          │
│    systemctl reload etcd-k8s-X.service                  │
│    (Zero downtime - hot reload of certificates)         │
└─────────────────────────────────────────────────────────┘
```

---

## Security Summary

### What NEVER Leaves Its Origin Node:

**On step-ca (etcd-k8s-1):**
1. ✅ `/etc/step-ca/secrets/root_ca_key` - Root CA private key
2. ✅ `/etc/step-ca/secrets/intermediate_ca_key` - Intermediate CA private key
3. ✅ `/etc/step-ca/secrets/password` - CA password

**On each etcd node:**
1. ✅ `etcd-k8s-X-peer.key` - Generated locally, never transmitted
2. ✅ `etcd-k8s-X-server.key` - Generated locally, never transmitted
3. ✅ `etcd-k8s-X-client.key` - Generated locally, never transmitted

### What Gets Transmitted (PUBLIC Data - Safe):
1. ✅ Certificate requests (HTTPS to step-ca)
2. ✅ Signed certificates (.crt files) - public data
3. ✅ CA certificates (.crt files) - public data

### Communication Flow:
```
etcd-k8s-2
    │
    │ HTTPS to step-ca port 9000
    │ "Please issue cert for etcd-k8s-2 with SANs..."
    ▼
step-ca on etcd-k8s-1
    │ - Validates request
    │ - Signs certificate with CA key (stays on etcd-k8s-1)
    │ - Returns signed certificate
    ▼
etcd-k8s-2
    │ - Receives signed certificate
    │ - Saves certificate locally
    │ - Private key was generated locally, never transmitted
```

**Security Guarantees:**
- ✅ All private keys generated on their target nodes
- ✅ No private keys transmitted over network
- ✅ step-ca CA keys never leave step-ca node
- ✅ All communication with step-ca is HTTPS encrypted
- ✅ Automatic certificate renewal ensures keys rotate regularly

---

## CA Redundancy: What If etcd-k8s-1 Dies?

### Option 1: Multiple Cert-Managers (Recommended)

**Setup:**
```ini
[etcd-cert-managers]
etcd-k8s-1  # Primary
etcd-k8s-2  # Backup (gets copy of CA keys)
etcd-k8s-3  # Backup (gets copy of CA keys)
```

**Initial Setup:**
```bash
# 1. Create CA on etcd-k8s-1 (normal)
ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=create

# 2. Backup CA keys to other nodes
ansible-playbook -i inventory.ini backup-ca-keys.yaml
```

**What backup-ca-keys.yaml does:**
```yaml
- hosts: etcd-k8s-1
  tasks:
    - name: Read CA keys
      slurp:
        src: "/etc/etcd/ssl/{{ item }}"
      register: ca_keys
      loop:
        - peer-ca.key
        - client-ca.key
      no_log: true  # Don't log private keys

- hosts: etcd-cert-managers
  tasks:
    - name: Install CA keys
      copy:
        content: "{{ item.content | b64decode }}"
        dest: "/etc/etcd/ssl/{{ item.item }}"
        owner: root
        mode: 0400
      loop: "{{ hostvars['etcd-k8s-1']['ca_keys'].results }}"
      no_log: true
```

**Now if etcd-k8s-1 dies:**
- Change inventory: `[etcd-cert-managers]` → `etcd-k8s-2`
- etcd-k8s-2 already has CA keys
- No disruption to certificate signing

### Option 2: Encrypted Backup to S3

```yaml
- hosts: etcd-k8s-1
  tasks:
    - name: Create encrypted CA backup
      shell: |
        tar czf - /etc/etcd/ssl/*-ca.key | \
        gpg --encrypt --recipient ops@example.com > /tmp/ca-backup.tar.gz.gpg

    - name: Upload to S3
      aws_s3:
        bucket: etcd-backups
        object: "ca-keys/{{ etcd_cluster_name }}-ca-{{ ansible_date_time.date }}.tar.gz.gpg"
        src: /tmp/ca-backup.tar.gz.gpg
        encrypt: yes
```

**To restore on new cert-manager:**
```bash
# Download backup
aws s3 cp s3://etcd-backups/ca-keys/... /tmp/ca-backup.tar.gz.gpg

# Decrypt and extract
gpg --decrypt /tmp/ca-backup.tar.gz.gpg | tar xzf - -C /

# Set permissions
chmod 0400 /etc/etcd/ssl/*-ca.key
```

---

## Adding New Node (etcd-k8s-4)

### Updated Inventory:
```ini
[etcd]
etcd-k8s-1
etcd-k8s-2
etcd-k8s-3
etcd-k8s-4  # NEW NODE

[etcd-cert-managers]
etcd-k8s-1  # Still the same CA
```

### Run Playbook (same as before):
```bash
ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=create --limit=etcd-k8s-4
```

### What Happens:

1. **ON etcd-k8s-4** - Generate private keys:
   ```
   openssl genrsa -out /etc/etcd/ssl/etcd-k8s-4-peer.key 2048
   openssl genrsa -out /etc/etcd/ssl/etcd-k8s-4-server.key 2048
   openssl genrsa -out /etc/etcd/ssl/etcd-k8s-4-client.key 2048
   ```

2. **ON etcd-k8s-4** - Create CSRs:
   ```
   cfssl gencert ... | cfssljson -bare etcd-k8s-4-peer
   # Creates etcd-k8s-4-peer.csr
   ```

3. **Transfer CSR** (public data) to Ansible Controller

4. **ON etcd-k8s-1** (cert-manager) - Sign with EXISTING CA:
   ```
   cfssl sign -ca=peer-ca.crt -ca-key=peer-ca.key ...
   # Uses SAME CA as other nodes!
   # NO new CA created!
   ```

5. **Transfer signed cert** back to etcd-k8s-4

6. **ON etcd-k8s-4** - Join cluster with new certs

### Key Points:
- ✅ CA stays the same (on etcd-k8s-1)
- ✅ Only etcd-k8s-4 gets new leaf certificates
- ✅ etcd-k8s-4's private keys NEVER leave etcd-k8s-4
- ✅ CA keys NEVER leave etcd-k8s-1

---

## Common Misunderstandings - CORRECTED

### ❌ "The developer laptop has the CA keys"
**✅ CORRECT:** CA keys are on etcd-k8s-1 (cert-manager node), not your laptop

### ❌ "Ansible stores private keys"
**✅ CORRECT:** Ansible only holds public data (CSRs, certs) in memory during execution

### ❌ "Local means on my laptop"
**✅ CORRECT:** "Local" means on the target node itself (etcd-k8s-2 generates keys ON etcd-k8s-2)

### ❌ "Cert-manager is a separate service"
**✅ CORRECT:** Cert-manager is just etcd-k8s-1 (an etcd node that also holds CA keys)

### ❌ "CA keys get transmitted to nodes"
**✅ CORRECT:** Only CA certificates (.crt) are distributed, never CA private keys (.key)

### ❌ "Adding a node requires rotating the CA"
**✅ CORRECT:** New nodes use the EXISTING CA, only new leaf certs are created

### ❌ "If etcd-k8s-1 dies, we lose the CA"
**✅ CORRECT:** Backup CA keys to other etcd nodes or encrypted storage for redundancy

---

## Verification Commands

### On etcd-k8s-1 (cert-manager):
```bash
# CA keys should exist and be owned by root
ls -la /etc/etcd/ssl/*-ca.key
# Should show: -r-------- 1 root root ... peer-ca.key

# CA keys should never be readable by others
stat -c '%a %U' /etc/etcd/ssl/peer-ca.key
# Should show: 400 root
```

### On etcd-k8s-2 (regular node):
```bash
# Should have its OWN private keys
ls -la /etc/etcd/ssl/etcd-k8s-2-*.key
# Should exist and be 0400

# Should NOT have CA private keys
ls /etc/etcd/ssl/*-ca.key
# Should show: No such file or directory

# Should have CA certificates (public)
ls -la /etc/etcd/ssl/*-ca.crt
# Should exist and be 0644
```

### On your laptop:
```bash
# Should NOT have any private keys
find ~/.ansible /tmp -name '*-ca.key' -o -name 'etcd-*.key'
# Should return nothing (or only temporary files in /tmp that get cleaned up)
```

---

## Summary Diagram

```
┌────────────────────────────────────────────────────────────────┐
│  YOUR UNDERSTANDING SHOULD BE:                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Your Laptop (Ansible Controller)                           │
│     - Runs playbooks                                           │
│     - SSH to all nodes                                         │
│     - Moves public data (CSRs, certs) between nodes            │
│     - NEVER stores private keys on disk                        │
│                                                                 │
│  2. etcd-k8s-1 (Cert-Manager = etcd node)                      │
│     - Regular etcd node                                        │
│     - ALSO holds CA keys (peer-ca.key, client-ca.key)          │
│     - Signs CSRs from other nodes                              │
│     - CA keys: /etc/etcd/ssl/*-ca.key (mode 0400, owner root)  │
│                                                                 │
│  3. etcd-k8s-2, etcd-k8s-3 (Regular etcd nodes)                │
│     - Generate their OWN private keys ON THEMSELVES            │
│     - Create CSRs ON THEMSELVES                                │
│     - Receive signed certs from cert-manager                   │
│     - Receive CA certs (public only)                           │
│     - DO NOT have CA private keys                              │
│                                                                 │
│  4. Flow for new cert:                                         │
│     Node generates key → Node creates CSR →                    │
│     Ansible moves CSR to cert-manager →                        │
│     Cert-manager signs CSR →                                   │
│     Ansible moves signed cert back to node →                   │
│     Node uses cert with its private key                        │
│                                                                 │
│  5. Security guarantees:                                       │
│     ✅ Private keys NEVER transmitted                          │
│     ✅ CA keys NEVER leave cert-manager                        │
│     ✅ Node keys NEVER leave their nodes                       │
│     ✅ Only public data moves via Ansible                      │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```
