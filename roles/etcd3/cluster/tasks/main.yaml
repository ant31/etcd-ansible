---

- name: Manage cluster
  include_tasks: manage-cluster.yaml
  vars:
    etcd_cluster_name: "{{cluster.etcd_cluster_name}}"
    etcd_ports: "{{cluster.etcd_ports}}"
    etcd_access_addresses: "{{cluster.etcd_access_addresses}}"
    etcd_access_addresses_semicolon: "{{cluster.etcd_access_addresses_semicolon}}"
    etcd_peer_addresses: "{{cluster.etcd_peer_addresses}}"
    etcd_peer_addresses_semicolon: "{{cluster.etcd_peer_addresses_semicolon}}"
    etcd_member_info: "{{cluster.etcd_members[inventory_hostname]}}"
    etcd_name: "{{cluster.etcd_members[inventory_hostname].etcd_name}}"
    etcd_address: "{{cluster.etcd_members[inventory_hostname].etcd_address}}"
    etcd_member_index: "{{cluster.etcd_members[inventory_hostname].etcd_member_index}}"
    etcd_access_address: "{{cluster.etcd_members[inventory_hostname].etcd_access_address}}"
    etcd_peer_url: "{{cluster.etcd_members[inventory_hostname].etcd_peer_url}}"
    etcd_client_url: "{{cluster.etcd_members[inventory_hostname].etcd_client_url}}"
    etcd_backup_dir: "{{cluster.etcd_members[inventory_hostname].etcd_backup_dir}}"
    etcd_backup_prefix: "{{cluster.etcd_members[inventory_hostname].etcd_backup_prefix}}"
    etcd_data_dir: "{{cluster.etcd_members[inventory_hostname].etcd_data_dir}}"
    _etcd_cluster_index: "{{loop.index}}"
  loop: "{{etcd_clusters_facts.values()}}"
  loop_control:
    loop_var: cluster


- include_role:
    name: etcd3/cluster/install
    public: yes
    apply:
      tags:
        - etcd
        - etcd-cluster
  when:
    - etcd_action | default('none') in ['upgrade', 'create']
  tags:
    - etcd
    - etcd-cluster
