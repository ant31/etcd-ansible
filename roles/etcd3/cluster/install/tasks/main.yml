---
- include_role:
    name: download
  vars:
    downloads: "{{etcd_downloads}}"
    download_container: false

- name: Checksum etcd binary
  stat:
    path: "{{ bin_dir }}/etcd"
  register: etcdbin

- name:
  file:
    path: "{{ bin_dir }}/etcd"
    state: absent
  when:
    - etcdbin.stat.exists
    - etcdbin.stat.isdir

- name: install | Copy etcd and etcdctl binary from download dir
  copy:
    src: "{{ bin_dir }}/etcd-archive/etcd-{{ etcd_version }}-linux-amd64/{{item}}"
    dest: "{{ bin_dir }}/"
    mode: 0755
    remote_src: yes
  with_items:
    - etcd
    - etcdctl

- name: Checksum etcd binary
  stat:
    path: "{{ bin_dir }}/etcd"
    checksum_algorithm: sha256
    get_checksum: yes
  register: etcdbin


- include_tasks: 0010_cluster.yaml
  loop: "{{etcd_clusters_facts.values()}}"
  loop_control:
    loop_var: cluster
  vars:
    etcd_cluster_name: "{{cluster.etcd_cluster_name}}"
    etcd_ports: "{{cluster.etcd_ports}}"
    etcd_access_addresses: "{{cluster.etcd_access_addresses}}"
    etcd_access_addresses_semicolon: "{{cluster.etcd_access_addresses_semicolon}}"
    etcd_peer_addresses: "{{cluster.etcd_peer_addresses}}"
    etcd_peer_addresses_semicolon: "{{cluster.etcd_peer_addresses_semicolon}}"
    etcd_member_info: "{{cluster.etcd_members[inventory_hostname]}}"
    etcd_name: "{{cluster.etcd_members[inventory_hostname].etcd_name}}"
    etcd_address: "{{cluster.etcd_members[inventory_hostname].etcd_address}}"
    etcd_member_index: "{{cluster.etcd_members[inventory_hostname].etcd_member_index}}"
    etcd_access_address: "{{cluster.etcd_members[inventory_hostname].etcd_access_address}}"
    etcd_peer_url: "{{cluster.etcd_members[inventory_hostname].etcd_peer_url}}"
    etcd_client_url: "{{cluster.etcd_members[inventory_hostname].etcd_client_url}}"
    etcd_backup_dir: "{{cluster.etcd_members[inventory_hostname].etcd_backup_dir}}"
    etcd_backup_prefix: "{{cluster.etcd_members[inventory_hostname].etcd_backup_prefix}}"
    etcd_data_dir: "{{cluster.etcd_members[inventory_hostname].etcd_data_dir}}"
