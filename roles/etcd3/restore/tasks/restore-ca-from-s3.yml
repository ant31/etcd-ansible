---
- name: Find latest CA backup in S3
  command: >
    aws s3api list-objects-v2
    --bucket {{ step_ca_backup_s3_bucket }}
    --prefix {{ step_ca_backup_s3_prefix }}/
    --query 'reverse(sort_by(Contents, &LastModified))[0].Key'
    --output text
  register: latest_backup
  when: restore_ca_s3_file == 'latest'
  changed_when: false
  tags:
    - restore-ca

- name: Set backup file path
  set_fact:
    ca_backup_s3_path: "{{ restore_ca_s3_file if restore_ca_s3_file != 'latest' else latest_backup.stdout }}"
  tags:
    - restore-ca

- name: Detect encryption method from backup file
  set_fact:
    backup_encryption_method: >-
      {%- if ca_backup_s3_path.endswith('.kms') -%}
      aws-kms
      {%- elif ca_backup_s3_path.endswith('.enc') -%}
      symmetric
      {%- else -%}
      none
      {%- endif -%}
  tags:
    - restore-ca

- name: Download CA backup from S3
  command: >
    {{ bin_dir }}/aws s3 cp
    s3://{{ step_ca_backup_s3_bucket }}/{{ ca_backup_s3_path }}
    /tmp/ca-restore-encrypted
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  tags:
    - restore-ca

- name: Decrypt CA backup with AWS KMS
  command: >
    {{ bin_dir }}/aws kms decrypt
    --ciphertext-blob fileb:///tmp/ca-restore-encrypted
    --output text
    --query Plaintext |
    base64 -d > /tmp/ca-restore.tar.gz
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when: backup_encryption_method == 'aws-kms'
  tags:
    - restore-ca

- name: Decrypt CA backup with symmetric encryption
  command: >
    openssl enc -aes-256-cbc -d -pbkdf2 -iter 100000
    -in /tmp/ca-restore-encrypted
    -out /tmp/ca-restore.tar.gz
    -pass pass:"{{ step_ca_backup_password }}"
  when: backup_encryption_method == 'symmetric'
  no_log: true
  tags:
    - restore-ca

- name: Copy unencrypted backup
  command: mv /tmp/ca-restore-encrypted /tmp/ca-restore.tar.gz
  when: backup_encryption_method == 'none'
  tags:
    - restore-ca

- name: Stop step-ca
  systemd:
    name: step-ca
    state: stopped
  ignore_errors: true
  tags:
    - restore-ca

- name: Extract CA backup
  unarchive:
    src: /tmp/ca-restore.tar.gz
    dest: /
    remote_src: yes
  tags:
    - restore-ca

- name: Set CA file permissions
  file:
    path: /etc/step-ca/secrets
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700
    recurse: yes
  tags:
    - restore-ca

- name: Cleanup temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/ca-restore-encrypted
    - /tmp/ca-restore.tar.gz
  tags:
    - restore-ca
