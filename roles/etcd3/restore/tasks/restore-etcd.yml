---
- name: Confirm etcd data restore
  pause:
    prompt: "You are about to restore etcd data. This will replace current cluster data. Continue? (yes/no)"
  register: restore_confirm_input
  when: restore_confirm | bool
  tags:
    - restore-etcd

- name: Validate confirmation
  assert:
    that:
      - not (restore_confirm | default(true) | bool) or (restore_confirm_input.user_input is defined and restore_confirm_input.user_input == 'yes')
    fail_msg: "âŒ Etcd data restore cancelled: user did not confirm with 'yes'"
  when: restore_confirm | default(true) | bool
  tags:
    - restore-etcd

- name: Find latest etcd backup in S3
  command: >
    {{ bin_dir }}/aws s3api list-objects-v2
    --bucket {{ etcd_upload_backup.bucket }}
    --prefix {{ etcd_upload_backup.prefix | default('') }}{{ etcd_cluster_name }}/
    --query 'reverse(sort_by(Contents, &LastModified))[0].Key'
    --output text
    --no-cli-pager
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  register: latest_etcd_backup
  when: 
    - restore_etcd_s3_file == 'latest'
    - restore_etcd_local_file == ''
  changed_when: false
  tags:
    - restore-etcd

- name: Set backup file path
  set_fact:
    etcd_backup_file_path: "{{ restore_etcd_s3_file if restore_etcd_s3_file != 'latest' else latest_etcd_backup.stdout }}"
  when: restore_etcd_local_file == ''
  tags:
    - restore-etcd

- name: Detect encryption method from backup file
  set_fact:
    backup_encryption_method: >-
      {%- if etcd_backup_file_path.endswith('.kms') -%}
      aws-kms
      {%- elif etcd_backup_file_path.endswith('.enc') -%}
      symmetric
      {%- else -%}
      none
      {%- endif -%}
  when: restore_etcd_local_file == ''
  tags:
    - restore-etcd

- name: Download etcd backup from S3
  command: >
    {{ bin_dir }}/aws s3 cp
    s3://{{ etcd_upload_backup.bucket }}/{{ etcd_backup_file_path }}
    /tmp/etcd-restore-encrypted
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when: restore_etcd_local_file == ''
  tags:
    - restore-etcd

- name: Decrypt etcd backup with AWS KMS
  command: >
    {{ bin_dir }}/aws kms decrypt
    --ciphertext-blob fileb:///tmp/etcd-restore-encrypted
    --output text
    --query Plaintext |
    base64 -d > /tmp/etcd-restore.db
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when: 
    - restore_etcd_local_file == ''
    - backup_encryption_method == 'aws-kms'
  tags:
    - restore-etcd

- name: Decrypt etcd backup with symmetric encryption
  command: >
    openssl enc -aes-256-cbc -d -pbkdf2 -iter 100000
    -in /tmp/etcd-restore-encrypted
    -out /tmp/etcd-restore.db
    -pass pass:"{{ step_ca_backup_password }}"
  when:
    - restore_etcd_local_file == ''
    - backup_encryption_method == 'symmetric'
  tags:
    - restore-etcd

- name: Copy unencrypted backup
  command: mv /tmp/etcd-restore-encrypted /tmp/etcd-restore.db
  when:
    - restore_etcd_local_file == ''
    - backup_encryption_method == 'none'
  tags:
    - restore-etcd

- name: Use local snapshot file
  copy:
    src: "{{ restore_etcd_local_file }}"
    dest: /tmp/etcd-restore.db
    remote_src: yes
  when: restore_etcd_local_file != ''
  tags:
    - restore-etcd

- name: Stop etcd service (if running)
  systemd:
    name: "{{ etcd_name }}"
    state: stopped
  failed_when: false
  tags:
    - restore-etcd

- name: Check if etcd data directory exists
  stat:
    path: "{{ etcd_data_dir }}"
  register: etcd_data_dir_stat
  when: restore_backup_existing | bool
  tags:
    - restore-etcd

- name: Backup current etcd data
  command: >
    mv {{ etcd_data_dir }}
    {{ etcd_data_dir }}.backup-{{ ansible_date_time.epoch }}
  when: 
    - restore_backup_existing | bool
    - etcd_data_dir_stat.stat.exists
  tags:
    - restore-etcd

- name: Restore etcd snapshot
  command: >
    {{ bin_dir }}/etcdutl snapshot restore /tmp/etcd-restore.db
    --name {{ etcd_name }}
    --initial-cluster {{ etcd_peer_addresses }}
    --initial-cluster-token {{ cluster_token | default(etcd_cluster_name) }}
    --initial-advertise-peer-urls {{ etcd_peer_url }}
    --data-dir {{ etcd_data_dir }}
    --skip-hash-check
    --bump-revision {{ restore_bump_revision | default(1000000000) }}
    --mark-compacted
  environment:
    ETCDCTL_API: "3"
  tags:
    - restore-etcd

- name: Set etcd data directory ownership
  file:
    path: "{{ etcd_data_dir }}"
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    recurse: yes
  tags:
    - restore-etcd

# Note: etcd service is NOT started here
# It must be started on ALL nodes together after ALL nodes are restored
# This is done in the playbook level to ensure proper cluster formation

- name: Cleanup temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/etcd-restore-encrypted
    - /tmp/etcd-restore.db
  tags:
    - restore-etcd
