---
# Certificate health check tasks

- name: Set output format default
  set_fact:
    output_format: "{{ output_format | default('text') }}"

- name: Check peer certificate expiration
  shell: >
    {{ bin_dir }}/step certificate inspect {{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-peer.crt
    --format json | jq -r '.validity.end'
  register: peer_cert_expiry
  changed_when: false
  failed_when: false

- name: Check server certificate expiration
  shell: >
    {{ bin_dir }}/step certificate inspect {{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-server.crt
    --format json | jq -r '.validity.end'
  register: server_cert_expiry
  changed_when: false
  failed_when: false

- name: Check client certificate expiration
  shell: >
    {{ bin_dir }}/step certificate inspect {{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-client.crt
    --format json | jq -r '.validity.end'
  register: client_cert_expiry
  changed_when: false
  failed_when: false

- name: Calculate days until peer cert expiration
  shell: >
    echo $(( ( $(date -d "{{ peer_cert_expiry.stdout }}" +%s) - $(date +%s) ) / 86400 ))
  register: peer_days_left
  changed_when: false
  when: peer_cert_expiry.rc == 0

- name: Check renewal timer status
  command: systemctl list-timers 'step-renew-*' --no-pager --no-legend
  register: renewal_timers
  changed_when: false
  failed_when: false

- name: Count active renewal timers
  shell: systemctl list-timers 'step-renew-*' --no-pager --no-legend | wc -l
  register: active_timers_count
  changed_when: false
  failed_when: false

- name: Display certificate status (text)
  debug:
    msg: |
      
      ┌─ CERTIFICATE STATUS - {{ inventory_hostname }} ──────────┐
      {% if peer_cert_expiry.rc == 0 %}
      Peer certificate expires:   {{ peer_cert_expiry.stdout }}
      Days until expiration:      {{ peer_days_left.stdout }}
      {% if peer_days_left.stdout | int < 30 %}
      ⚠️  WARNING: Certificate expires in less than 30 days!
      {% elif peer_days_left.stdout | int < 90 %}
      ⚠️  NOTICE: Certificate expires in less than 90 days
      {% else %}
      ✅ Certificate valid for {{ peer_days_left.stdout }} days
      {% endif %}
      {% else %}
      ❌ Failed to read certificate
      {% endif %}
      
      Server cert expires:        {{ server_cert_expiry.stdout if server_cert_expiry.rc == 0 else 'UNKNOWN' }}
      Client cert expires:        {{ client_cert_expiry.stdout if client_cert_expiry.rc == 0 else 'UNKNOWN' }}
      
      Active renewal timers:      {{ active_timers_count.stdout }}
      {% if active_timers_count.stdout | int != 3 %}
      ⚠️  WARNING: Expected 3 renewal timers, found {{ active_timers_count.stdout }}
      {% else %}
      ✅ All renewal timers active
      {% endif %}
      └────────────────────────────────────────────────────────────┘
  when: output_format == 'text'
