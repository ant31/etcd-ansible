---
- name: Install CA backup script (static file)
  copy:
    src: ca-backup-check.py
    dest: "{{ backup_scripts_dir }}/ca-backup-check.py"
    owner: root
    group: root
    mode: 0755
  tags:
    - ca-backup-cron

- name: Install CA backup configuration (templated, tracked)
  template:
    src: ca-backup-config.yaml.j2
    dest: "{{ backup_scripts_dir }}/ca-backup-config.yaml"
    owner: root
    group: root
    mode: 0600
    backup: yes
  tags:
    - ca-backup-cron


- name: Setup CA backup cron job (runs as root - CA files are root-only)
  cron:
    name: "Check and backup CA if changed"
    minute: "{{ ca_backup_cron_minute }}"
    hour: "{{ ca_backup_cron_hour }}"
    job: "/usr/bin/python3 {{ backup_scripts_dir }}/ca-backup-check.py --config {{ backup_scripts_dir }}/ca-backup-config.yaml >> {{ backup_log_dir }}/ca-backup.log 2>&1"
    user: root
    state: present
  when: ca_backup_cron_enabled | default(true) | bool
  tags:
    - ca-backup-cron

- name: Verify CA backup cron job is installed
  shell: "crontab -l -u root | grep -c 'ca-backup-check.py' || true"
  register: ca_cron_check
  changed_when: false
  tags:
    - ca-backup-cron

- name: Display CA backup cron status
  debug:
    msg: "{{ ['CA backup cron job: ' + ('INSTALLED' if ca_cron_check.stdout|int > 0 else 'NOT FOUND')] }}"
  tags:
    - ca-backup-cron

- name: Get next CA backup check time
  shell: |
    CRON_LINE=$(crontab -l -u root 2>/dev/null | grep 'ca-backup-check.py' | head -1)
    if [ -z "$CRON_LINE" ]; then
      echo "NOT SCHEDULED"
      exit 0
    fi
    MINUTE=$(echo "$CRON_LINE" | awk '{print $1}')
    echo "Schedule: $MINUTE {{ ca_backup_cron_hour }} * * * (checks every {{ ca_backup_check_interval }} minute interval)"
  register: ca_backup_schedule
  changed_when: false
  when: ca_backup_cron_enabled | default(true) | bool
  tags:
    - ca-backup-cron

- name: Display CA backup schedule
  debug:
    msg:
      - "âœ… CA backup cron configured (change-based)"
      - "{{ ca_backup_schedule.stdout }}"
      - "Log file: {{ backup_log_dir }}/ca-backup.log"
      - ""
      - "Note: CA only backs up when files change (checks every {{ ca_backup_check_interval }} minutes)"
      - ""
      - "To verify: ansible-playbook -i inventory.ini playbooks/verify-backup-cron.yaml"
  when: 
    - ca_backup_cron_enabled | default(true) | bool
    - ca_backup_schedule is defined
  tags:
    - ca-backup-cron

- name: Setup CA backup log rotation
  copy:
    dest: /etc/logrotate.d/etcd-ca-backup
    content: |
      {{ backup_log_dir }}/ca-backup.log {
        daily
        rotate 30
        compress
        delaycompress
        missingok
        notifempty
      }
    owner: root
    group: root
    mode: 0644
  tags:
    - ca-backup-cron
