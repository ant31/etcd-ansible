#!/bin/bash
# Etcd data backup script - runs periodically
# Generated by Ansible - do not edit manually

set -euo pipefail

BACKUP_DIR="{{ etcd_cluster_backup.directory }}"
ETCD_ENDPOINTS="{{ etcd_access_addresses }}"
CERT="{{ etcd_cert_paths.client.cert }}"
KEY="{{ etcd_cert_paths.client.key }}"
CACERT="{{ etcd_cert_paths.client.ca }}"
S3_BUCKET="{{ etcd_upload_backup.bucket }}"
S3_PREFIX="{{ etcd_upload_backup.prefix | default('') }}"
KMS_KEY_ID="{{ step_ca_backup_kms_key_id }}"
CLUSTER_NAME="{{ etcd_cluster_name }}"
RETENTION_DAYS="{{ etcd_backup_retention_days }}"
HEALTHCHECK_URL="{{ backup_healthcheck_url }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

# Create etcd snapshot
create_snapshot() {
    local timestamp=$(date +%Y-%m-%d_%H-%M-%S)
    local year=$(date +%Y)
    local month=$(date +%m)
    local snapshot_file="${BACKUP_DIR}/${year}/${month}/${CLUSTER_NAME}-${timestamp}-snapshot.db"
    local encrypted_file="${snapshot_file}.kms"
    
    # Create directory
    mkdir -p "$(dirname "$snapshot_file")"
    
    log "Creating etcd snapshot..."
    {{ bin_dir }}/etcdctl \
        --endpoints="$ETCD_ENDPOINTS" \
        --cert="$CERT" \
        --cacert="$CACERT" \
        --key="$KEY" \
        snapshot save "$snapshot_file"
    
    log "Verifying snapshot..."
    {{ bin_dir }}/etcdutl snapshot status "$snapshot_file" --write-out=table
    
    log "Encrypting snapshot with KMS..."
    aws kms encrypt \
        --key-id "$KMS_KEY_ID" \
        --plaintext "fileb://${snapshot_file}" \
        --output text \
        --query CiphertextBlob | base64 -d > "$encrypted_file"
    
    log "Uploading to S3..."
    aws s3 cp "$encrypted_file" \
        "s3://${S3_BUCKET}/${S3_PREFIX}${CLUSTER_NAME}/${year}/${month}/$(basename $encrypted_file)" \
        --sse aws:kms \
        --sse-kms-key-id "$KMS_KEY_ID"
    
    # Keep latest snapshot link
    aws s3 cp "$encrypted_file" \
        "s3://${S3_BUCKET}/${S3_PREFIX}${CLUSTER_NAME}/latest-snapshot.db.kms" \
        --sse aws:kms \
        --sse-kms-key-id "$KMS_KEY_ID"
    
    # Keep local unencrypted snapshot
    cp "$snapshot_file" "${BACKUP_DIR}/${CLUSTER_NAME}-snapshot.db"
    
    # Cleanup encrypted file
    rm -f "$encrypted_file"
    
    log "Snapshot complete: s3://${S3_BUCKET}/${S3_PREFIX}${CLUSTER_NAME}/${year}/${month}/$(basename $encrypted_file)"
}

# Cleanup old backups
cleanup_old_backups() {
    log "Cleaning up backups older than ${RETENTION_DAYS} days..."
    
    find "$BACKUP_DIR" -type f -name "*.db" -mtime "+${RETENTION_DAYS}" -delete
    
    # Cleanup empty directories
    find "$BACKUP_DIR" -type d -empty -delete
}

# Main logic
main() {
    log "Starting etcd backup for cluster: $CLUSTER_NAME"
    
    # Check etcd health
    if ! {{ bin_dir }}/etcdctl --endpoints="$ETCD_ENDPOINTS" \
        --cert="$CERT" --cacert="$CACERT" --key="$KEY" \
        endpoint health > /dev/null 2>&1; then
        log "ERROR: Etcd cluster is unhealthy, skipping backup"
        return 1
    fi
    
    # Create snapshot
    if create_snapshot; then
        log "Backup successful"
        
        # Cleanup old backups
        cleanup_old_backups
        
        # Send healthcheck ping if configured
        if [ -n "$HEALTHCHECK_URL" ]; then
            curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null 2>&1 || log "WARNING: Healthcheck ping failed"
        fi
        
        return 0
    else
        log "ERROR: Backup failed"
        return 1
    fi
}

export ETCDCTL_API=3
main "$@"
