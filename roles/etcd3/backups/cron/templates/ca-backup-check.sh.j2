#!/bin/bash
# CA backup script - only backs up when CA files change
# Generated by Ansible - do not edit manually

set -euo pipefail

BACKUP_DIR="{{ etcd_cluster_backup.directory }}"
STATE_FILE="/var/lib/etcd-ca-backup/last-backup-checksum"
CA_SECRETS_DIR="/etc/step-ca/secrets"
CA_CONFIG_DIR="/etc/step-ca/config"
S3_BUCKET="{{ step_ca_backup_s3_bucket }}"
S3_PREFIX="{{ step_ca_backup_s3_prefix }}"
KMS_KEY_ID="{{ step_ca_backup_kms_key_id }}"
HEALTHCHECK_URL="{{ ca_backup_healthcheck_url }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

# Calculate checksum of CA files
calculate_checksum() {
    find "$CA_SECRETS_DIR" "$CA_CONFIG_DIR" -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1
}

# Backup CA files to S3 with KMS encryption
backup_ca() {
    local timestamp=$(date +%Y-%m-%d_%H-%M-%S)
    local year=$(date +%Y)
    local month=$(date +%m)
    local temp_archive="/tmp/ca-backup-${timestamp}.tar.gz"
    local encrypted_file="/tmp/ca-backup-${timestamp}.tar.gz.kms"
    
    log "Creating CA backup archive..."
    tar czf "$temp_archive" -C / etc/step-ca/secrets etc/step-ca/config
    
    log "Encrypting with AWS KMS..."
    aws kms encrypt \
        --key-id "$KMS_KEY_ID" \
        --plaintext "fileb://${temp_archive}" \
        --output text \
        --query CiphertextBlob | base64 -d > "$encrypted_file"
    
    log "Uploading to S3..."
    aws s3 cp "$encrypted_file" \
        "s3://${S3_BUCKET}/${S3_PREFIX}/${year}/${month}/ca-backup-${timestamp}.tar.gz.kms" \
        --sse aws:kms \
        --sse-kms-key-id "$KMS_KEY_ID"
    
    # Keep latest backup link
    aws s3 cp "$encrypted_file" \
        "s3://${S3_BUCKET}/${S3_PREFIX}/latest-ca-backup.tar.gz.kms" \
        --sse aws:kms \
        --sse-kms-key-id "$KMS_KEY_ID"
    
    # Cleanup
    rm -f "$temp_archive" "$encrypted_file"
    
    log "Backup complete: s3://${S3_BUCKET}/${S3_PREFIX}/${year}/${month}/ca-backup-${timestamp}.tar.gz.kms"
}

# Main logic
main() {
    log "Checking if CA files changed..."
    
    current_checksum=$(calculate_checksum)
    
    if [ -f "$STATE_FILE" ]; then
        last_checksum=$(cat "$STATE_FILE")
        
        if [ "$current_checksum" = "$last_checksum" ]; then
            log "No changes detected, skipping backup"
            return 0
        fi
        
        log "CA files changed, creating new backup"
    else
        log "First run, creating initial backup"
    fi
    
    # Perform backup
    if backup_ca; then
        echo "$current_checksum" > "$STATE_FILE"
        log "Backup successful, checksum saved"
        
        # Send healthcheck ping if configured
        if [ -n "$HEALTHCHECK_URL" ]; then
            curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null 2>&1 || log "WARNING: Healthcheck ping failed"
        fi
        
        return 0
    else
        log "ERROR: Backup failed"
        return 1
    fi
}

main "$@"
