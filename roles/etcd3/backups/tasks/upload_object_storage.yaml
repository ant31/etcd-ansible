---
# Upload etcd snapshot to S3 with same encryption as cron backups
# Supports: aws-kms, symmetric, none (controlled by step_ca_backup_encryption_method)

- name: Set encryption variables
  set_fact:
    backup_encryption_method: "{{ step_ca_backup_encryption_method if not (deactivate_backup_encryption | default(false) | bool) else 'none' }}"
    backup_timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.time }}"
  when: etcd_upload_backup.storage in ['s3', 'aws']

- name: Calculate snapshot checksum
  stat:
    path: "{{ etcd_backup_file }}"
    checksum_algorithm: sha256
    get_checksum: yes
  register: snapshot_stat
  when: etcd_upload_backup.storage in ['s3', 'aws']

- name: Encrypt backup with AWS KMS
  shell: |
    {{ bin_dir }}/aws kms encrypt \
      --key-id {{ step_ca_backup_kms_key_id }} \
      --plaintext fileb://{{ etcd_backup_file }} \
      --output text \
      --query CiphertextBlob | base64 -d > {{ etcd_backup_file }}.kms
  environment:
    AWS_ACCESS_KEY_ID: "{{ etcd_upload_backup.access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ etcd_upload_backup.secret_key }}"
    AWS_DEFAULT_REGION: "{{ etcd_upload_backup.region | d('us-east-1') }}"
  when:
    - etcd_upload_backup.storage in ['s3', 'aws']
    - backup_encryption_method == 'aws-kms'
  register: kms_encrypt_result

- name: Encrypt backup with symmetric encryption (AES-256-CBC)
  shell: |
    openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
      -in {{ etcd_backup_file }} \
      -out {{ etcd_backup_file }}.enc \
      -pass pass:"{{ step_ca_backup_password }}"
  when:
    - etcd_upload_backup.storage in ['s3', 'aws']
    - backup_encryption_method == 'symmetric'
  no_log: true
  register: symmetric_encrypt_result

- name: Set final backup file and S3 suffix
  set_fact:
    final_backup_file: >-
      {%- if backup_encryption_method == 'aws-kms' -%}
      {{ etcd_backup_file }}.kms
      {%- elif backup_encryption_method == 'symmetric' -%}
      {{ etcd_backup_file }}.enc
      {%- else -%}
      {{ etcd_backup_file }}
      {%- endif -%}
    s3_file_suffix: >-
      {%- if backup_encryption_method == 'aws-kms' -%}
      .kms
      {%- elif backup_encryption_method == 'symmetric' -%}
      .enc
      {%- else -%}

      {%- endif -%}
  when: etcd_upload_backup.storage in ['s3', 'aws']

- name: Calculate encrypted file checksum
  stat:
    path: "{{ final_backup_file }}"
    checksum_algorithm: sha256
    get_checksum: yes
  register: encrypted_stat
  when: etcd_upload_backup.storage in ['s3', 'aws']

- name: Upload encrypted backup to S3 (timestamped path)
  shell: |
    {{ bin_dir }}/aws s3 cp {{ final_backup_file }} \
      s3://{{ etcd_upload_backup.bucket }}/{{ etcd_upload_backup.prefix | d('') }}{{ etcd_cluster_name }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}/{{ etcd_backup_file | basename }}{{ s3_file_suffix }} \
      --metadata "backup-timestamp={{ backup_timestamp }},snapshot-checksum={{ snapshot_stat.stat.checksum }},encrypted-checksum={{ encrypted_stat.stat.checksum }},encryption-method={{ backup_encryption_method }}"
  environment:
    AWS_ACCESS_KEY_ID: "{{ etcd_upload_backup.access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ etcd_upload_backup.secret_key }}"
    AWS_DEFAULT_REGION: "{{ etcd_upload_backup.region | d('us-east-1') }}"
    AWS_ENDPOINT_URL: "{{ etcd_upload_backup.s3_url | d(omit) }}"
  when: etcd_upload_backup.storage in ['s3', 'aws']
  register: s3_upload_result

- name: Upload as latest pointer
  shell: |
    {{ bin_dir }}/aws s3 cp {{ final_backup_file }} \
      s3://{{ etcd_upload_backup.bucket }}/{{ etcd_upload_backup.prefix | d('') }}{{ etcd_cluster_name }}/latest-snapshot.db{{ s3_file_suffix }} \
      --metadata "backup-timestamp={{ backup_timestamp }},snapshot-checksum={{ snapshot_stat.stat.checksum }},encrypted-checksum={{ encrypted_stat.stat.checksum }},retention=long-term"
  environment:
    AWS_ACCESS_KEY_ID: "{{ etcd_upload_backup.access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ etcd_upload_backup.secret_key }}"
    AWS_DEFAULT_REGION: "{{ etcd_upload_backup.region | d('us-east-1') }}"
    AWS_ENDPOINT_URL: "{{ etcd_upload_backup.s3_url | d(omit) }}"
  when: etcd_upload_backup.storage in ['s3', 'aws']
  failed_when: false

- name: Cleanup encrypted file
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ etcd_backup_file }}.kms"
    - "{{ etcd_backup_file }}.enc"
  when:
    - etcd_upload_backup.storage in ['s3', 'aws']
    - backup_encryption_method != 'none'

- name: Display upload result
  debug:
    msg: |
      ✅ Backup uploaded to S3
      
      Path: s3://{{ etcd_upload_backup.bucket }}/{{ etcd_upload_backup.prefix | d('') }}{{ etcd_cluster_name }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}/{{ etcd_backup_file | basename }}{{ s3_file_suffix }}
      Encryption: {{ backup_encryption_method }}
      {% if backup_encryption_method == 'aws-kms' %}
      KMS Key: {{ step_ca_backup_kms_key_id }}
      {% elif backup_encryption_method == 'symmetric' %}
      Encrypted with: Password from vault.yml
      {% elif backup_encryption_method == 'none' %}
      ⚠️  WARNING: Uploaded UNENCRYPTED (deactivate_backup_encryption={{ deactivate_backup_encryption }})
      {% endif %}
      Snapshot checksum: {{ snapshot_stat.stat.checksum }}
      Encrypted checksum: {{ encrypted_stat.stat.checksum }}
      
      Backup also available at: s3://{{ etcd_upload_backup.bucket }}/{{ etcd_upload_backup.prefix | d('') }}{{ etcd_cluster_name }}/latest-snapshot.db{{ s3_file_suffix }}
  when:
    - etcd_upload_backup.storage in ['s3', 'aws']
    - s3_upload_result is succeeded
