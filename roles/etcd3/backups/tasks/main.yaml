---
# Manual backup - call the same script as cron for consistency
# This ensures identical behavior: encryption validation, naming convention, etc.

- name: Ensure backup script exists
  stat:
    path: "{{ backup_scripts_dir }}/etcd-backup.py"
  register: backup_script_check
  tags:
    - backup

- name: Fail if backup script missing
  fail:
    msg: |
      ❌ Backup script not found: {{ backup_scripts_dir }}/etcd-backup.py
      
      The backup cron role must be applied first to install the script.
      
      To fix:
        ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=deploy --tags backup-cron -b
  when: not backup_script_check.stat.exists
  tags:
    - backup

- name: Run backup script (always independent mode)
  command: "/usr/bin/python3 {{ backup_scripts_dir }}/etcd-backup.py --config {{ backup_scripts_dir }}/etcd-backup-config.yaml --independent {{ '--force' if etcd_backup_offline | default(false) | bool else '' }}"
  become: yes
  become_user: "{{ etcd_user.name }}"
  environment:
    ETCDCTL_API: "3"
  register: manual_backup_result
  tags:
    - backup

- name: Display backup result
  debug:
    msg: |
      ✅ Backup completed
      
      {{ manual_backup_result.stdout }}
      
      Mode: INDEPENDENT (always creates new backup, no deduplication)
      {% if etcd_backup_offline | default(false) | bool %}
      Force mode: ENABLED (backed up even if cluster unhealthy)
      ⚠️  This backup may contain inconsistent data if cluster was not in quorum.
      {% endif %}
      
      The backup was created using the same process as automated cron backups.
      This ensures consistent encryption validation and naming conventions.
      
      Check logs: {{ backup_log_dir }}/etcd-backup.log
  when: manual_backup_result.rc == 0
  tags:
    - backup

- name: Display backup failure
  debug:
    msg: |
      ❌ Backup FAILED
      
      Error:
      {{ manual_backup_result.stderr }}
      
      Troubleshooting:
      1. Check backup logs: tail -f {{ backup_log_dir }}/etcd-backup.log
      2. Check config: cat {{ backup_scripts_dir }}/etcd-backup-config.yaml
      3. Verify cluster health: etcdctl endpoint health
      4. Check if etcd is running: systemctl status etcd-*
      
      To force backup even when cluster is unhealthy:
        ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=backup -e etcd_backup_offline=true -b
  when: manual_backup_result.rc != 0
  tags:
    - backup
