---
- name: Refresh Time Fact
  setup: filter=ansible_date_time

- name: Set Backup Directory
  set_fact:
    etcd_backup_file: "{{etcd_cluster_backup.directory}}/{{ansible_date_time.year}}/{{ansible_date_time.month}}/{{etcd_cluster_name}}-{{ansible_date_time.date}}_{{ansible_date_time.time}}-snapshot.db"
    etcd_backup_latest: "{{etcd_cluster_backup.directory}}/{{etcd_cluster_name}}-snapshot.db"

- name: Create Backup Directory
  file:
    path: "{{etcd_backup_file | dirname}}"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0755

- name: ETCD | Check if etcd cluster is healthy
  command: >-
    {{bin_dir}}/etcdctl --endpoints={{etcd_access_addresses}}
    --cert={{etcd_cert_paths.client.cert}}
    --cacert={{etcd_cert_paths.client.ca}}
    --key={{etcd_cert_paths.client.key}}
    endpoint health
  register: etcd_cluster_is_healthy
  changed_when: false
  retries: 4
  delay: "{{retry_stagger | default(5)}}"
  until: etcd_cluster_is_healthy.rc == 0
  ignore_errors: true
  environment:
    ETCDCTL_API: "3"

- name:
  fail:
    msg: >-
      Can't create a live backup, the cluster is not healthy.
      It's possible to try with `etcd_backup_offline=true` to create a backup from the 'member/snap/db' file
  when:
    - etcd_cluster_is_healthy is failed
    - not etcd_backup_offline | d(false) | bool
    - not etcd_force_backup | d(false) | bool

- name: Backup etcd v3 data
  command: >-
    {{bin_dir}}/etcdctl --endpoints={{etcd_client_url}}
    --cert={{etcd_cert_paths.client.cert}}
    --cacert={{etcd_cert_paths.client.ca}}
    --key={{etcd_cert_paths.client.key}}
    snapshot save "{{etcd_backup_file}}"
  register: etcd_snapshot
  environment:
    ETCDCTL_API: "3"
  when:
    - etcd_cluster_is_healthy is succeeded or etcd_force_backup|d(false)|bool

- name: Verify snapshot integrity with etcdutl
  command: >-
    {{bin_dir}}/etcdutl snapshot status "{{etcd_backup_file}}"
    --write-out=table
  register: snapshot_verification
  failed_when: snapshot_verification.rc != 0
  when:
    - etcd_snapshot is succeeded
  tags:
    - verify-backup

- name: Display snapshot verification results
  debug:
    var: snapshot_verification.stdout_lines
  when:
    - snapshot_verification is succeeded
  tags:
    - verify-backup

- name: backup from 'member/snap/db' file
  copy:
    remote_src: true
    src: "{{etcd_data_dir}}/member/snap/db"
    dest: "{{etcd_backup_file}}"
  register: offline_backup
  when:
    - etcd_backup_offline | d(false) | bool
    - etcd_cluster_is_healthy is failed

- name: Verify offline snapshot integrity with etcdutl
  command: >-
    {{bin_dir}}/etcdutl snapshot status "{{etcd_backup_file}}"
    --write-out=table
  register: offline_snapshot_verification
  failed_when: offline_snapshot_verification.rc != 0
  when:
    - offline_backup is succeeded
  tags:
    - verify-backup

- name: Display offline snapshot verification results
  debug:
    var: offline_snapshot_verification.stdout_lines
  when:
    - offline_snapshot_verification is succeeded
  tags:
    - verify-backup

- name: Copy latest snapshot
  copy:
    remote_src: true
    src:  "{{etcd_backup_file}}"
    dest: "{{etcd_backup_latest}}"

- import_tasks: "upload_object_storage.yaml"
  when:
    - etcd_upload_backup is defined
    - etcd_upload_backup.storage in ['gcs', 's3', 'aws']
