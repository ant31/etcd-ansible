---
# Manual backup - scripts installed via cron role dependency
# This ensures identical behavior: encryption validation, naming convention, etc.

# Note: Initial backups are automatically skipped during manual runs
# (skip_initial_backup=true is set in meta/main.yaml)

- name: Run backup script (always independent mode, runs as root)
  command: "/usr/bin/python3 {{ backup_scripts_dir }}/etcd-backup.py --config {{ backup_scripts_dir }}/etcd-backup-config.yaml --independent {{ '--online-only' if etcd_backup_online_only | default(false) | bool else '' }}"
  become: yes
  become_user: root
  environment:
    ETCDCTL_API: "3"
  register: manual_backup_result
  tags:
    - backup

- name: Display backup result
  debug:
    msg:
      - "✅ Backup completed"
      - ""
      - "{{ manual_backup_result.stdout }}"
      - ""
      - "Mode: INDEPENDENT (always creates new backup, no deduplication)"
      - "Behavior: ALWAYS BACKUP (default - backups even if cluster unhealthy)"
      - ""
      - "Filename indicates cluster health status:"
      - "- *-online-snapshot.db = Cluster was healthy during backup"
      - "- *-offline-snapshot.db = Cluster was unhealthy during backup"
      - ""
      - "The backup was created using the same process as automated cron backups."
      - "This ensures consistent encryption validation and naming conventions."
      - ""
      - "SHA256 checksum files are automatically created for verification:"
      - "- Stored alongside backup: *.sha256"
      - "- Can be used to verify decrypted backups"
      - ""
      - "To decrypt and verify a backup:"
      - "  python3 {{ backup_scripts_dir }}/etcd-backup.py \\"
      - "    --config {{ backup_scripts_dir }}/etcd-backup-config.yaml \\"
      - "    --decrypt --input backup.db.kms --output backup.db"
      - "  (Checksum verification is automatic if .sha256 file exists)"
      - ""
      - "To decrypt without verification:"
      - "  python3 {{ backup_scripts_dir }}/etcd-backup.py \\"
      - "    --config {{ backup_scripts_dir }}/etcd-backup-config.yaml \\"
      - "    --decrypt --input backup.db.kms --output backup.db --no-verify"
      - ""
      - "Check logs: {{ backup_log_dir }}/etcd-backup.log"
  when: manual_backup_result.rc == 0
  tags:
    - backup

- name: Display backup failure
  debug:
    msg:
      - "❌ Backup FAILED"
      - ""
      - "Error:"
      - "{{ manual_backup_result.stderr | default(manual_backup_result.stdout) | default('No error output') }}"
      - ""
      - "Troubleshooting:"
      - "1. Check backup logs: tail -f {{ backup_log_dir }}/etcd-backup.log"
      - "2. Check config: cat {{ backup_scripts_dir }}/etcd-backup-config.yaml"
      - "3. Check backup directory permissions: ls -la {{ etcd_backup_dir }}"
      - "4. Verify cluster health: etcdctl endpoint health"
      - "5. Check if etcd is running: systemctl status etcd-*"
      - "6. Check AWS credentials: aws s3 ls s3://{{ etcd_upload_backup.bucket }}"
      - ""
      - "Note: Default behavior is to backup regardless of cluster health."
  when: manual_backup_result.rc != 0
  tags:
    - backup
