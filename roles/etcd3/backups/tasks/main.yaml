---
# Manual backup - call the same script as cron for consistency
# This ensures identical behavior: encryption validation, naming convention, etc.

- name: Ensure backup script exists
  stat:
    path: "{{ backup_scripts_dir }}/etcd-backup.py"
  register: backup_script_check
  tags:
    - backup

- name: Fail if backup script missing
  fail:
    msg: |
      ❌ Backup script not found: {{ backup_scripts_dir }}/etcd-backup.py
      
      The backup cron role must be applied first to install the script.
      
      To fix:
        ansible-playbook -i inventory.ini etcd.yaml -e etcd_action=deploy --tags backup-cron -b
  when: not backup_script_check.stat.exists
  tags:
    - backup

- name: Run backup script (same as cron)
  command: "/usr/bin/python3 {{ backup_scripts_dir }}/etcd-backup.py --config {{ backup_scripts_dir }}/etcd-backup-config.yaml"
  become: yes
  become_user: "{{ etcd_user.name }}"
  environment:
    ETCDCTL_API: "3"
  register: manual_backup_result
  tags:
    - backup

- name: Display backup result
  debug:
    msg: |
      ✅ Backup completed
      
      {{ manual_backup_result.stdout }}
      
      The backup was created using the same process as automated cron backups.
      This ensures consistent encryption validation and naming conventions.
      
      Check logs: {{ backup_log_dir }}/etcd-backup.log
  when: manual_backup_result.rc == 0
  tags:
    - backup

- name: Display backup failure
  debug:
    msg: |
      ❌ Backup FAILED
      
      {{ manual_backup_result.stderr }}
      
      Troubleshooting:
      1. Check backup logs: tail -f {{ backup_log_dir }}/etcd-backup.log
      2. Check config: cat {{ backup_scripts_dir }}/etcd-backup-config.yaml
      3. Run manually for debugging: sudo -u {{ etcd_user.name }} python3 {{ backup_scripts_dir }}/etcd-backup.py --config {{ backup_scripts_dir }}/etcd-backup-config.yaml
      4. Verify cluster health: etcdctl endpoint health
  when: manual_backup_result.rc != 0
  tags:
    - backup
