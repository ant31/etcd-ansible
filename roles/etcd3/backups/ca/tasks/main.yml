---
# Manual CA backup - calls same script as cron
# This ensures identical behavior: SHA256 files, encryption validation, etc.

# Note: Initial backups are automatically skipped during manual runs
# (skip_initial_backup=true is set in meta/main.yaml)

- name: Run CA backup script (always force mode, runs as root)
  command: "/usr/bin/python3 {{ backup_scripts_dir }}/ca-backup-check.py --config {{ backup_scripts_dir }}/ca-backup-config.yaml --force"
  become: yes
  become_user: root
  register: manual_ca_backup_result
  tags:
    - backup

- name: Display backup result
  debug:
    msg:
      - "✅ CA backup completed"
      - ""
      - "{{ manual_ca_backup_result.stdout }}"
      - ""
      - "Mode: MANUAL (always creates new backup with --force flag)"
      - ""
      - "The backup was created using the same process as automated cron backups."
      - "This ensures consistent encryption validation, SHA256 files, and naming conventions."
      - ""
      - "SHA256 checksum files are automatically created for verification:"
      - "- Stored alongside backup: *.sha256"
      - "- Can be used to verify decrypted backups"
      - ""
      - "To decrypt and verify a backup:"
      - "  python3 {{ backup_scripts_dir }}/ca-backup-check.py \\"
      - "    --config {{ backup_scripts_dir }}/ca-backup-config.yaml \\"
      - "    --decrypt --input backup.tar.gz.kms --output backup.tar.gz"
      - "  (Checksum verification is automatic if .sha256 file exists)"
      - ""
      - "To decrypt without verification:"
      - "  python3 {{ backup_scripts_dir }}/ca-backup-check.py \\"
      - "    --config {{ backup_scripts_dir }}/ca-backup-config.yaml \\"
      - "    --decrypt --input backup.tar.gz.kms --output backup.tar.gz --no-verify"
      - ""
      - "Check logs: {{ backup_log_dir }}/ca-backup.log"
  when: manual_ca_backup_result.rc == 0
  tags:
    - backup

- name: Display backup failure
  debug:
    msg:
      - "❌ CA backup FAILED"
      - ""
      - "Error:"
      - "{{ manual_ca_backup_result.stderr | default(manual_ca_backup_result.stdout) | default('No error output') }}"
      - ""
      - "Troubleshooting:"
      - "1. Check backup logs: tail -f {{ backup_log_dir }}/ca-backup.log"
      - "2. Check config: cat {{ backup_scripts_dir }}/ca-backup-config.yaml"
      - "3. Check backup directory permissions: ls -la {{ etcd_backup_dir }}"
      - "4. Verify step-ca is running: systemctl status step-ca"
      - "5. Check CA files exist: ls -la /etc/step-ca/secrets/"
      - "6. Check AWS credentials: aws s3 ls s3://{{ step_ca_backup_s3_bucket }}"
      - ""
      - "Note: Manual backup always runs with --force (creates backup regardless of changes)."
  when: manual_ca_backup_result.rc != 0
  tags:
    - backup
