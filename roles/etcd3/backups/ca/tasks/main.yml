---
# CA backup tasks - moved from playbooks/backup-ca.yaml
# Usage: Set ca_backup_action variable (manual or cron)

- name: Validate encryption method
  assert:
    that:
      - step_ca_backup_encryption_method in ['aws-kms', 'symmetric', 'aws-s3-sse']
    fail_msg: "Invalid encryption method. Choose: aws-kms, symmetric, or aws-s3-sse"
  tags:
    - backup
    - validate

- name: Validate KMS configuration
  assert:
    that:
      - step_ca_backup_kms_key_id is defined
      - step_ca_backup_kms_key_id | length > 0
    fail_msg: "KMS key ID must be set when using aws-kms encryption"
  when: step_ca_backup_encryption_method == 'aws-kms'
  tags:
    - backup
    - validate

- name: Validate symmetric encryption password
  assert:
    that:
      - step_ca_backup_password is defined
      - step_ca_backup_password | length > 0
    fail_msg: "Backup password must be set in ansible-vault when using symmetric encryption"
  when: step_ca_backup_encryption_method == 'symmetric'
  tags:
    - backup
    - validate

- name: Gather date/time facts
  setup:
    filter: ansible_date_time
  tags:
    - backup

- name: Set backup variables
  set_fact:
    backup_dir: /tmp
    backup_file: "step-ca-backup-{{ ansible_date_time.date }}.tar.gz"
  tags:
    - backup

- name: Create CA backup archive
  archive:
    path:
      - /etc/step-ca/secrets
      - /etc/step-ca/config
    dest: "{{ backup_dir }}/{{ backup_file }}"
    format: gz
  tags:
    - backup

- name: Encrypt backup with AWS KMS
  shell: |
    {{ bin_dir }}/aws kms encrypt \
      --key-id {{ step_ca_backup_kms_key_id }} \
      --plaintext fileb://{{ backup_dir }}/{{ backup_file }} \
      --output text \
      --query CiphertextBlob | base64 -d > {{ backup_dir }}/{{ backup_file }}.kms
  when: step_ca_backup_encryption_method == 'aws-kms'
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  tags:
    - backup
    - encrypt

- name: Encrypt backup with symmetric encryption (AES-256)
  shell: |
    openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
      -in {{ backup_dir }}/{{ backup_file }} \
      -out {{ backup_dir }}/{{ backup_file }}.enc \
      -pass pass:{{ step_ca_backup_password }}
  when: step_ca_backup_encryption_method == 'symmetric'
  no_log: true
  tags:
    - backup
    - encrypt

- name: Set encrypted backup filename
  set_fact:
    encrypted_file: >-
      {%- if step_ca_backup_encryption_method == 'aws-kms' -%}
      {{ backup_file }}.kms
      {%- elif step_ca_backup_encryption_method == 'symmetric' -%}
      {{ backup_file }}.enc
      {%- else -%}
      {{ backup_file }}
      {%- endif -%}
  tags:
    - backup

- name: Upload encrypted backup to S3 with KMS (timestamped)
  shell: |
    {{ bin_dir }}/aws s3 cp {{ backup_dir }}/{{ encrypted_file }} \
      s3://{{ step_ca_backup_s3_bucket }}/{{ step_ca_backup_s3_prefix }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}/{{ encrypted_file }}
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when: 
    - step_ca_backup_s3_enabled
    - step_ca_backup_encryption_method in ['aws-kms', 'aws-s3-sse']
  tags:
    - backup
    - upload

- name: Upload encrypted backup to S3 (symmetric encryption, timestamped)
  shell: |
    {{ bin_dir }}/aws s3 cp {{ backup_dir }}/{{ encrypted_file }} \
      s3://{{ step_ca_backup_s3_bucket }}/{{ step_ca_backup_s3_prefix }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}/{{ encrypted_file }}
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when:
    - step_ca_backup_s3_enabled
    - step_ca_backup_encryption_method == 'symmetric'
  tags:
    - backup
    - upload

- name: Upload as latest pointer (for replication)
  shell: |
    {{ bin_dir }}/aws s3 cp {{ backup_dir }}/{{ encrypted_file }} \
      s3://{{ step_ca_backup_s3_bucket }}/{{ step_ca_backup_s3_prefix }}/latest-ca-backup.tar.gz{{ '.kms' if step_ca_backup_encryption_method == 'aws-kms' else ('.enc' if step_ca_backup_encryption_method == 'symmetric' else '') }}
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id | default('') }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key | default('') }}"
    AWS_DEFAULT_REGION: "{{ aws_default_region | default('us-east-1') }}"
  when: 
    - step_ca_backup_s3_enabled
  tags:
    - backup
    - upload

- name: Cleanup local backup files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ backup_dir }}/{{ backup_file }}"
    - "{{ backup_dir }}/{{ backup_file }}.kms"
    - "{{ backup_dir }}/{{ backup_file }}.enc"
  tags:
    - backup
    - cleanup

- name: Display backup location and method
  debug:
    msg: |
      âœ… Backup uploaded to s3://{{ step_ca_backup_s3_bucket }}/{{ step_ca_backup_s3_prefix }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}/{{ encrypted_file }}
      
      Encryption method: {{ step_ca_backup_encryption_method }}
      {% if step_ca_backup_encryption_method == 'aws-kms' %}
      KMS Key: {{ step_ca_backup_kms_key_id }}
      {% elif step_ca_backup_encryption_method == 'symmetric' %}
      Decryption: Use password from ansible-vault
      {% endif %}
      
      To restore:
        ansible-playbook -i inventory.ini playbooks/restore-ca-from-backup.yaml -e target_node=TARGET_NODE --vault-password-file ~/.vault-pass
  when: step_ca_backup_s3_enabled
  tags:
    - backup
