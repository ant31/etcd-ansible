---
etcd_cluster_group: etcd
etcd_clients_group: etcd_clients
etcd_certmanagers_group: etcd_cert_managers
etcd_all_hosts: "{{groups[etcd_cluster_group] + groups[etcd_clients_group] + groups[etcd_certmanagers_group] | unique}}"
etcd_clusters: {}

# ============================================================================
# CLUSTER-SPECIFIC CONFIGURATION
# ============================================================================
# Define per-cluster settings in a dictionary keyed by cluster name
# This makes it easy to configure multiple clusters with different settings
#
# Example configuration (add to group_vars/all/etcd.yaml or inventory):
#
# etcd_cluster_configs:
#   k8s:  # Main Kubernetes cluster
#     client_port: 2379
#     peer_port: 2380
#     backup_s3_bucket: "my-backups"
#     backup_s3_prefix: "prod/k8s/"
#     backup_interval: "*/30"
#     backup_retention_days: 90
#     backup_distributed: true
#     lb_enabled: true
#     lb_host: "etcd-k8s.internal"
#     lb_ip: "10.0.1.100"
#     cert_alt_names: ["etcd.kube-system.svc"]
#     cert_alt_ips: ["10.0.1.100"]
#     quota_backend_bytes: "8G"
#   k8s-events:  # Events cluster (different settings)
#     client_port: 2381
#     peer_port: 2382
#     backup_interval: "*/60"
#     backup_s3_prefix: "prod/events/"
#     backup_retention_days: 30
#     backup_distributed: false
#   legacy:  # Old cluster (no backups)
#     client_port: 2383
#     peer_port: 2384
#     backup_enabled: false
#
# Available cluster-specific settings (all optional overrides):
#
# Network & Ports (flat):
# - client_port / peer_port
# - lb_enabled / lb_host / lb_port / lb_ip
#
# Backup Configuration (flat):
# - backup_enabled / backup_interval / backup_s3_bucket / backup_s3_prefix
# - backup_retention_days / backup_distributed / backup_independent / backup_online_only
# - ca_backup_enabled / ca_backup_check_interval / ca_backup_retention_days
#
# Certificates (flat):
# - cert_alt_names (list of DNS SANs)
# - cert_alt_ips (list of IP SANs)
#
# Performance Tuning:
# - performance.heartbeat_interval / performance.election_timeout
# - performance.snapshot_count / performance.compaction_retention
# - performance.quota_backend_bytes / performance.metrics
#
# Systemd Service:
# - systemd.timeout_start_sec / systemd.restart_sec / systemd.limit_nofile
# - systemd.nice_level / systemd.ionice_class / systemd.ionice_priority
# - systemd.memory_limit / systemd.cpu_quota
#
# Security:
# - security.secure_client / security.peer_client_auth
#
# step-ca:
# - step_ca.runtime_minutes / step_ca.port
#
# Monitoring:
# - monitoring.backup_healthcheck_url / monitoring.ca_backup_healthcheck_url
#
etcd_cluster_configs: {}

# Load balancer configuration (optional)
# Enable this to use a load balancer in front of etcd for stable client connectivity
# Only affects client traffic (port 2379) - peer traffic (2380) stays direct
etcd_lb_enabled: false
etcd_lb_host: ""  # e.g., "etcd-lb.internal.example.com"
etcd_lb_port: 2379  # Optional, defaults to etcd client port
etcd_lb_ip: ""  # Optional VIP, e.g., "10.0.1.100"
# Backup directory (root-owned, everything under /opt/backups)
etcd_backup_dir: "/opt/backups"
etcd_cluster_backup_directory: "{{etcd_backup_dir}}/etcd/{{etcd_cluster_name}}"

# ============================================================================
# CLUSTER ACTIONS
# ============================================================================
# etcd_action controls what operation to perform on the cluster
#
# CREATE (new cluster initialization):
#   - No backup (nothing to backup yet)
#   - Can cleanup/force create directories (etcd_force_create=true)
#   - Starts ALL nodes SIMULTANEOUSLY (parallel)
#   - No cluster health checks beforehand
#   - Sets initial-cluster-state: new
#   - Use for: First-time cluster creation
#
# DEPLOY (idempotent cluster operations):
#   - ALWAYS creates backup before changes
#   - Only applies needed changes
#   - Restarts nodes ONE-BY-ONE (serial, maintains quorum)
#   - Checks cluster health before/after
#   - Can involve: config changes, version upgrades, etc.
#   - Sets initial-cluster-state: existing
#   - Use for: Any operation on a running cluster
#
# Example usage:
#   Create new cluster:
#     ansible-playbook etcd.yaml -e etcd_action=create
#
#   Upgrade existing cluster:
#     ansible-playbook etcd.yaml -e etcd_action=deploy -e etcd_version=v3.5.26
#
#   Apply config changes:
#     ansible-playbook etcd.yaml -e etcd_action=deploy
#
etcd_action: deploy

# DEPRECATED: etcd_new_cluster is no longer needed
# Use etcd_action=create for new clusters instead
# This variable will be removed in a future version
# Migration:
#   OLD: -e etcd_action=deploy -e etcd_new_cluster=true
#   NEW: -e etcd_action=create
etcd_new_cluster: null
etcd_ca_profiles: {'server': 'client', 'client': 'client', 'peer': 'peer'}
bin_dir: /opt/bin
download_cache_dir: "{{ bin_dir }}"
etcd_config_dir: /etc/etcd
etcd_cert_dir: "{{ etcd_config_dir }}/ssl"
etcd_client_cert_dir: /etc/etcd-client/ssl  # Separate directory for client-only nodes
dns_domain: cluster.local
etcd_backup: yes

# Disable backup encryption (defaults to false - encryption is ON by default)
# Set to true to skip encryption (uploads plain .db files to S3)
# WARNING: Only use in non-production or when S3 has bucket-level encryption
deactivate_backup_encryption: false

# ============================================================================
# S3 BACKUP STORAGE (flat variables)
# ============================================================================
# Note: AWS credentials use top-level aws_* variables (no duplication)
etcd_backup_s3_bucket: ""       # S3 bucket name for etcd data backups
etcd_backup_s3_prefix: ""       # S3 prefix/folder (e.g., "prod/k8s/" or "etcd/")

# All backup operations use these flat variables
# No nested dicts - allows easy CLI override: -e etcd_backup_s3_bucket=mybucket

################
## DOWNLOADS
################

# ============================================================================
# DEFAULT NETWORK PORTS (can be overridden per-cluster)
# ============================================================================
etcd_cluster_name: default
etcd_client_port: 2379
etcd_peer_port: 2380

# Note: When using etcd_cluster_configs, these defaults are automatically
# merged with cluster-specific settings in the facts role.
# All variables use FLAT structure (no nested dicts) for easy CLI override.

cfssl_version: 1.6.5

# Smallstep versions and checksums
step_version: "0.25.2"
step_ca_version: "0.25.2"

step_checksums:
  "0.25.2": "sha256:ee82b99f431e006318cc6e284d9f8d91c0515dc6a0023dc87de3ab6b1c2a8b8d"
  "0.29.0": "sha256:4e043c2f63aee5a0fa5512dec82c4109b83fd88f9c924f8911ad697c061a40d8"
  
step_ca_checksums:
  "0.25.2": "sha256:c0b4a1b0fa1fdc88a8e08e27c45b7b4cf8e5e2d97ae0e7f9c33fc8aef0e85eba"
  "0.29.0": "sha256:817094de196bbd878919c6b4fe027f8cdbcee3ffe6f2e441ef98a63b3942ab3d"
  
etcd_checksums:
  v3.5.13: "sha256:31e6fcbee0e8c3df27cf1ba69b522e338377f5ed6447f5d05700aee367f3b7e7"
  v3.5.26: "sha256:0a682a91201dc8351d507210bc30b021a11e254eab806f03224b51e8fad29abb"
  v3.6.7: "sha256:cf8af880c5a01ee5363cefa14a3e0cb7e5308dcf4ed17a6973099c9a7aee5a9a"
  

etcd_version: v3.5.26


etcd_download_url: "https://storage.googleapis.com/etcd/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-amd64.tar.gz"

etcd_downloads:
  etcd:
    file: true
    enabled: true
    dest: "{{ download_cache_dir }}/etcd-archive/etcd-{{ etcd_version }}-linux-amd64.tar.gz"
    sha256: "{{ etcd_checksums[etcd_version] | default(omit)}}"
    url: "{{ etcd_download_url }}"
    unarchive: true
    owner: "root"
    mode: "0755"
    groups:
      - "{{etcd_cluster_group}}"
      - "etcd-all"  # Support aggregate group for multi-cluster
  
  awscli:
    file: true
    enabled: "{{ etcd_backup_cron_enabled | default(false) or ca_backup_cron_enabled | default(false) }}"
    dest: "{{ download_cache_dir }}/awscli-archive/awscliv2.zip"
    url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
    unarchive: true
    owner: "root"
    mode: "0755"
    groups:
      - "{{etcd_cluster_group}}"
      - "{{etcd_certmanagers_group}}"
      - "etcd-all"  # Support aggregate group for multi-cluster
  
  step:
    file: true
    enabled: true
    dest: "{{ download_cache_dir }}/step-archive/step_linux_{{ step_version }}_amd64.tar.gz"         
    url: "https://github.com/smallstep/cli/releases/download/v{{ step_version }}/step_linux_{{ step_version }}_amd64.tar.gz"
    sha256: "{{ step_checksums[step_version] | default(omit) }}"
    unarchive: true
    owner: "root"
    mode: "0755"
    groups:
      - "{{etcd_cluster_group}}"
      - "{{etcd_clients_group}}"
      - "{{etcd_certmanagers_group}}"
      - "etcd-all"  # Support aggregate group for multi-cluster
  
  step_ca:
    file: true
    enabled: true
    dest: "{{ download_cache_dir }}/step-ca-archive/step-ca_linux_{{ step_ca_version }}_amd64.tar.gz"
    url: "https://github.com/smallstep/certificates/releases/download/v{{ step_ca_version }}/step-ca_linux_{{ step_ca_version }}_amd64.tar.gz"
    sha256: "{{ step_ca_checksums[step_ca_version] | default(omit) }}"
    unarchive: true
    owner: "root"
    mode: "0755"
    groups:
      - "{{etcd_certmanagers_group}}"
      - "etcd-all"  # Support aggregate group for multi-cluster
  
###########
## CERTS
##########3
# Note: cert_expiry kept for backward compatibility but not used with Smallstep
# Smallstep uses step_cert_default_duration (2 years) defined in smallstep role
cert_expiry: 175200h


# Set to true to separate k8s events to a different etcd cluster
etcd_events_cluster_enabled: false


etcd_home: "/var/lib/etcd/"

# Certificate Subject Alternative Names (SANs)
# These DNS names and IPs are added to the server certificate
# IMPORTANT: If using a load balancer, add the LB hostname/IP here!
#
# Example with load balancer:
#   etcd_cert_alt_names:
#     - "{{ etcd_lb_host }}"  # Load balancer hostname
#     - "etcd.kube-system.svc.{{ dns_domain }}"
#   etcd_cert_alt_ips:
#     - "{{ etcd_lb_ip }}"  # Load balancer VIP
#
# Default includes common Kubernetes DNS names:
etcd_cert_alt_names:
  - "etcd.kube-system.svc.{{ dns_domain }}"
  - "etcd.kube-system.svc"
  - "etcd.kube-system"
  - "etcd"
etcd_cert_alt_ips: []

etcd_script_dir: "{{ bin_dir }}/etcd-scripts"

# Performance tuning (can be overridden per-cluster)
etcd_heartbeat_interval: 250
etcd_election_timeout: 5000
etcd_snapshot_count: 10000
etcd_quota_backend_bytes: 0  # 0 = unlimited

# etcd_snapshot_count: 10000

# Parameters for ionice
# -c takes an integer between 0 and 3 or one of the strings none, realtime, best-effort or idle.
# -n takes an integer between 0 (highest priority) and 7 (lowest priority)
# etcd_ionice: "-c2 -n0"

etcd_metrics: "extensive"

## A dictionary of extra environment variables to add to etcd.env, formatted like:
##  etcd_extra_vars:
##    ETCD_VAR1: "value1"
##    ETCD_VAR2: "value2"
etcd_extra_vars: {}

# etcd_quota_backend_bytes: "2G"

etcd_compaction_retention: "8"

# Force clients like etcdctl to use TLS certs (different than peer security)
etcd_secure_client: true

# Enable peer client cert authentication
etcd_peer_client_auth: true

# Skip certificate generation during deploy (assumes certs already exist)
# Set to true to skip all cert generation/renewal setup and just ensure step-ca is running
# Useful for: config changes, quick deploys when certs are already valid
# Default: false (always setup/verify certificates)
etcd_skip_cert_generation: false

# AWS credentials for backup encryption (set in vault.yml)
aws_access_key_id: ""
aws_secret_access_key: ""
aws_default_region: "us-east-1"

# ============================================================================
# SMALLSTEP CA CONFIGURATION (used by roles/etcd3/certs/smallstep)
# ============================================================================
step_ca_name: "etcd-{{ etcd_cluster_name }}-ca"
step_ca_port: 9000
step_ca_provisioner: "etcd-provisioner"

# CA DNS and URL (dynamic based on cert-manager node)
# Use IP address for step-ca, following same pattern as etcd facts
# Try access_ip first, then ip, then discovered IP
step_ca_dns: "{{ hostvars[groups[etcd_certmanagers_group][0]].get('access_ip', hostvars[groups[etcd_certmanagers_group][0]].get('ip', hostvars[groups[etcd_certmanagers_group][0]]['ansible_default_ipv4']['address'])) }}"
step_ca_url: "https://{{ step_ca_dns }}:{{ step_ca_port }}"

# Paths
step_path: "/etc/step-ca"
step_ca_config: "{{ step_path }}/config/ca.json"
step_ca_db: "{{ step_path }}/db"
step_ca_certs: "{{ step_path }}/certs"
step_ca_secrets: "{{ step_path }}/secrets"

# Certificate settings
step_cert_default_duration: "17520h"  # 2 years (730 days)
step_cert_max_duration: "26280h"      # 3 years
step_cert_min_duration: "1h"

# Renewal settings - renew when 2/3 of lifetime has passed
step_cert_renew_period: "11688h"  # ~487 days (2/3 of 2 years)

# step-ca runtime limit (security: minimize CA exposure)
# Time in minutes that step-ca will run before auto-shutdown
# 0 = infinite (always running), recommended: 30-60 minutes
step_ca_runtime_minutes: 60  # 1 hour default

# Password for CA keys (should be stored in ansible-vault in production)
step_ca_password: ""
step_provisioner_password: ""

# ============================================================================
# CA BACKUP CONFIGURATION (used by roles/etcd3/backups/ca)
# ============================================================================
# Backup encryption configuration
step_ca_backup_encryption_method: "aws-kms"  # Options: aws-kms, symmetric, none
step_ca_backup_s3_bucket: "etcd-backups"  # S3 bucket for CA backups
step_ca_backup_s3_prefix: "step-ca"  # S3 prefix/folder
step_ca_backup_s3_enabled: true  # Enable S3 uploads
step_ca_backup_retention_days: 365  # Delete backups older than this

# AWS KMS encryption (when step_ca_backup_encryption_method: aws-kms)
step_ca_backup_kms_key_id: "alias/etcd-ca-backup"  # AWS KMS key alias or ARN

# Symmetric encryption (when step_ca_backup_encryption_method: symmetric)
step_ca_backup_password: ""  # Encryption password (store in ansible-vault)

# ============================================================================
# AUTOMATED BACKUP CRON CONFIGURATION (used by roles/etcd3/backups/cron)
# ============================================================================
# Backup scheduling - ENABLED BY DEFAULT
# Can be overridden per-cluster via etcd_cluster_configs[cluster_name].backup.*
etcd_backup_cron_enabled: true
etcd_backup_cron_minute: "*/30"
etcd_backup_cron_hour: "*"
etcd_backup_interval: "*/30"  # Alias for cron_minute

# Distributed backup strategy (high availability)
etcd_backup_distributed: true  # Enable multi-node backups
etcd_backup_independent: true  # If true, nodes don't check for existing backups (higher frequency)

# Online-only backup mode (abort if cluster unhealthy)
# Default: false (always backup regardless of health, filename indicates online/offline)
# Set to true with: -e etcd_backup_online_only=true
# etcd_backup_online_only: false  # Default is false (backup always, mark health in filename)

# CA backup - only when changed - ENABLED BY DEFAULT
# Can be overridden per-cluster via etcd_cluster_configs[cluster_name].ca_backup.*
ca_backup_cron_enabled: true
ca_backup_cron_minute: "*/5"
ca_backup_cron_hour: "*"
ca_backup_check_interval: "*/5"  # Alias for cron_minute

# Trigger initial backup after deployment
etcd_backup_initial_run: true
ca_backup_initial_run: true

# Deadman monitoring (optional)
backup_healthcheck_enabled: false
backup_healthcheck_url: ""
ca_backup_healthcheck_url: ""

# Backup paths (all organized under /opt/backups)
backup_scripts_dir: "/opt/backups"
backup_log_dir: "/var/log/etcd-backups"
backup_tmp_dir: "/opt/backups/tmp"

# Cluster-specific backup paths (includes cluster name for multi-cluster support)
etcd_backup_config_file: "{{ backup_scripts_dir }}/etcd-backup-config-{{ etcd_cluster_name }}.yaml"
ca_backup_config_file: "{{ backup_scripts_dir }}/ca-backup-config-{{ etcd_cluster_name }}.yaml"
etcd_backup_log_file: "{{ backup_log_dir }}/etcd-backup-{{ etcd_cluster_name }}.log"
ca_backup_log_file: "{{ backup_log_dir }}/ca-backup-{{ etcd_cluster_name }}.log"
ca_backup_state_file: "/var/lib/etcd-ca-backup/last-backup-checksum-{{ etcd_cluster_name }}"

# Local backup retention (controls local disk cleanup only, not S3)
# S3 retention must be configured separately via S3 lifecycle policies
etcd_backup_local_retention_days: 90
ca_backup_local_retention_days: 365

# Automatic cleanup of old local backups
# Set to false to disable automatic cleanup (manual cleanup required)
# Default: true (cleanup runs after successful backup, never fails backup)
etcd_backup_cleanup_enabled: true
ca_backup_cleanup_enabled: true

# Certificate renewal monitoring (optional)
# Healthcheck URL for certificate renewal success/failure notifications
# Examples:
#   - Healthchecks.io: https://hc-ping.com/your-uuid
#   - Deadman's Snitch: https://nosnch.in/your-snitch-id
#   - Custom webhook: https://your-monitoring.example.com/webhook
# Leave empty to disable
step_cert_renewal_healthcheck_url: ""

# ============================================================================
# RESTORE CONFIGURATION (used by roles/etcd3/restore)
# ============================================================================
# What to restore
restore_ca: false
restore_etcd_data: false

# CA restore options
restore_ca_from: "s3"  # Options: s3, local, backup-node
restore_ca_source_node: ""  # Source node name if restore_ca_from: backup-node
restore_ca_s3_file: "latest"  # S3 object path or 'latest'

# Etcd data restore options
restore_etcd_s3_file: "latest"  # S3 object path or 'latest'
restore_etcd_local_file: ""  # Local snapshot file path

# Skip download phase (snapshot already downloaded to /tmp/etcd-restore-{cluster}.db)
restore_skip_download: false

# Revision bump (recommended for Kubernetes to invalidate informer caches)
restore_bump_revision: 1000000000

# Safety options
restore_confirm: true  # Require confirmation before restore
restore_backup_existing: true  # Backup existing data before restore

# Force CA replication on backup cert-managers (cert-managers[1:]) during deployment
# Set to true to replace existing CA on BACKUP nodes when replicating from primary
# Set to false to preserve existing CA and fail if fingerprints don't match
# Only affects backup cert-managers, never the primary
# When true, automatically triggers cleanup (badger DB, cache) to prevent key mismatch errors
# Default: true (automatic replication during deployment with cleanup)
# Used during: Normal deployment when multiple cert-managers configured
etcd_force_ca_replication: true

# Force CA replacement on ALL cert-managers (including primary) - DISASTER RECOVERY ONLY
# Set to true to replace CA on ALL nodes during restore/regeneration
# THIS IS EXTREMELY RARE - only for complete CA rebuild scenarios
# WARNING: Requires explicit confirmation (type 'yes-force-replace-all')
# Default: false (must be explicitly requested, affects ALL cert-managers)
# Used during: Disaster recovery when CA is compromised on all nodes
# Normal replication: Use etcd_force_ca_replication instead (backup nodes only)
etcd_force_ca_replacement: false

# Force step-ca cleanup on backup cert-managers before CA restore
# Set to true to clean badger database and cache (fixes "PrivateKey doesn't match" error)
# Only affects backup cert-managers (cert-managers[1:]), never the primary
# Default: false (cleanup must be explicitly requested)
step_ca_force_cleanup: false

etcd_user:
    name: etcd
    comment: "Etcd user"
    createhome: yes
    home: "{{ etcd_home }}"
    system: yes
    shell: /bin/nologin

# Systemd service tuning
etcd_systemd_timeout_start_sec: "60s"
etcd_systemd_restart_sec: "15s"
etcd_systemd_limit_nofile: 40000
# Optional performance tuning (undefined by default)
# etcd_systemd_nice_level: 0  # -20 (highest) to 19 (lowest)
# etcd_systemd_ionice_class: 2  # 0=none, 1=realtime, 2=best-effort, 3=idle
# etcd_systemd_ionice_priority: 0  # 0 (highest) to 7 (lowest)
# etcd_systemd_memory_limit: "2G"
# etcd_systemd_cpu_quota: "200%"  # Percentage of CPU (200% = 2 cores)

# Certificate paths for cluster nodes
# Client nodes in etcd_clients group use etcd_client_cert_dir separately
etcd_cert_paths:
  server:
    cert: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-server.crt"
    key: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-server.key"
    ca: "{{ etcd_cert_dir }}/client-ca.crt"
  client:
    cert: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-client.crt"
    key: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-client.key"
    ca: "{{ etcd_cert_dir }}/client-ca.crt"
  peer:
    cert: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-peer.crt"
    key: "{{ etcd_cert_dir }}/etcd-{{ etcd_cluster_name }}-peer.key"
    ca: "{{ etcd_cert_dir }}/peer-ca.crt"
