---
# Generate initial certificates using step-ca
- name: Generate etcd peer certificate
  shell: |
    {{ bin_dir }}/step ca certificate \
      "{{ etcd_name }}" \
      {{ etcd_cert_dir }}/{{ etcd_name }}-peer.crt \
      {{ etcd_cert_dir }}/{{ etcd_name }}-peer.key \
      --provisioner="{{ step_ca_provisioner }}" \
      --provisioner-password-file=<(echo "{{ step_provisioner_password }}") \
      --ca-url="{{ step_ca_url }}" \
      --root="{{ etcd_cert_dir }}/root_ca.crt" \
      --san="{{ ansible_fqdn }}" \
      --san="{{ ansible_hostname }}" \
      --san="{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}" \
      --san="127.0.0.1" \
      --san="localhost" \
      --not-after="{{ step_cert_default_duration }}"
  args:
    executable: /bin/bash
    creates: "{{ etcd_cert_dir }}/{{ etcd_name }}-peer.crt"
  when: inventory_hostname in groups[etcd_cluster_group]
  no_log: true

- name: Generate etcd server certificate
  shell: |
    {{ bin_dir }}/step ca certificate \
      "{{ etcd_name }}-server" \
      {{ etcd_cert_dir }}/{{ etcd_name }}-server.crt \
      {{ etcd_cert_dir }}/{{ etcd_name }}-server.key \
      --provisioner="{{ step_ca_provisioner }}" \
      --provisioner-password-file=<(echo "{{ step_provisioner_password }}") \
      --ca-url="{{ step_ca_url }}" \
      --root="{{ etcd_cert_dir }}/root_ca.crt" \
      --san="{{ ansible_fqdn }}" \
      --san="{{ ansible_hostname }}" \
      --san="{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}" \
      --san="127.0.0.1" \
      --san="localhost" \
      --not-after="{{ step_cert_default_duration }}"
  args:
    executable: /bin/bash
    creates: "{{ etcd_cert_dir }}/{{ etcd_name }}-server.crt"
  when: inventory_hostname in groups[etcd_cluster_group]
  no_log: true

- name: Generate etcd client certificate
  shell: |
    {{ bin_dir }}/step ca certificate \
      "{{ etcd_name }}-client" \
      {{ etcd_cert_dir }}/{{ etcd_name }}-client.crt \
      {{ etcd_cert_dir }}/{{ etcd_name }}-client.key \
      --provisioner="{{ step_ca_provisioner }}" \
      --provisioner-password-file=<(echo "{{ step_provisioner_password }}") \
      --ca-url="{{ step_ca_url }}" \
      --root="{{ etcd_cert_dir }}/root_ca.crt" \
      --not-after="{{ step_cert_default_duration }}"
  args:
    executable: /bin/bash
    creates: "{{ etcd_cert_dir }}/{{ etcd_name }}-client.crt"
  no_log: true

- name: Set certificate permissions
  file:
    path: "{{ item }}"
    owner: "{{ etcd_cert_user }}"
    group: "{{ etcd_cert_group }}"
    mode: 0400
  loop:
    - "{{ etcd_cert_dir }}/{{ etcd_name }}-peer.key"
    - "{{ etcd_cert_dir }}/{{ etcd_name }}-server.key"
    - "{{ etcd_cert_dir }}/{{ etcd_name }}-client.key"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Set client certificate permissions
  file:
    path: "{{ etcd_cert_dir }}/{{ etcd_name }}-client.key"
    owner: "{{ etcd_cert_user }}"
    group: "{{ etcd_cert_group }}"
    mode: 0400

- name: Create symlinks for CA certificates
  file:
    src: "{{ etcd_cert_dir }}/root_ca.crt"
    dest: "{{ item }}"
    state: link
  loop:
    - "{{ etcd_cert_dir }}/peer-ca.crt"
    - "{{ etcd_cert_dir }}/client-ca.crt"

- name: Create certificate renewal service for peer cert
  template:
    src: step-renew.service.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-peer.service"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}"
    cert_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-peer.crt"
    key_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-peer.key"
    exec_start_post: "/bin/systemctl reload {{ etcd_name }}.service"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Create certificate renewal timer for peer cert
  template:
    src: step-renew.timer.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-peer.timer"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}-peer"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Create certificate renewal service for server cert
  template:
    src: step-renew.service.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-server.service"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}-server"
    cert_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-server.crt"
    key_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-server.key"
    exec_start_post: "/bin/systemctl reload {{ etcd_name }}.service"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Create certificate renewal timer for server cert
  template:
    src: step-renew.timer.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-server.timer"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}-server"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Create certificate renewal service for client cert
  template:
    src: step-renew.service.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-client.service"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}-client"
    cert_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-client.crt"
    key_path: "{{ etcd_cert_dir }}/{{ etcd_name }}-client.key"
    exec_start_post: ""

- name: Create certificate renewal timer for client cert
  template:
    src: step-renew.timer.j2
    dest: "/etc/systemd/system/step-renew-{{ etcd_name }}-client.timer"
    mode: 0644
  vars:
    cert_name: "{{ etcd_name }}-client"

- name: Enable and start renewal timers
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  loop:
    - "step-renew-{{ etcd_name }}-peer.timer"
    - "step-renew-{{ etcd_name }}-server.timer"
    - "step-renew-{{ etcd_name }}-client.timer"
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Enable and start client renewal timer
  systemd:
    name: "step-renew-{{ etcd_name }}-client.timer"
    enabled: yes
    state: started
    daemon_reload: yes
  when: inventory_hostname in groups[etcd_clients_group]
