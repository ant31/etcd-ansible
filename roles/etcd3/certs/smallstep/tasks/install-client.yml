---
- name: Install step CLI on client nodes
  copy:
    src: "{{ bin_dir }}/step-archive/step_{{ step_version }}/bin/step"
    dest: "{{ bin_dir }}/step"
    mode: 0755
    remote_src: yes

- name: Create step configuration directory
  file:
    path: "{{ etcd_cert_dir }}/.step"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700

- name: Install root CA certificate
  copy:
    content: "{{ step_ca_root_cert }}"
    dest: "{{ etcd_cert_dir }}/root_ca.crt"
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0644

- name: Bootstrap step CLI
  command: >
    {{ bin_dir }}/step ca bootstrap
    --ca-url {{ step_ca_url }}
    --fingerprint $({{ bin_dir }}/step certificate fingerprint {{ etcd_cert_dir }}/root_ca.crt)
    --install
  environment:
    STEPPATH: "{{ etcd_cert_dir }}/.step"
  changed_when: false
