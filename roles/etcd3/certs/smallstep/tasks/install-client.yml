---
- name: Check if step CLI is installed
  stat:
    path: "{{ bin_dir }}/step"
  register: step_cli_installed

- name: Fail if step CLI binary not installed
  fail:
    msg:
      - "❌ step CLI binary not found"
      - "Expected location: {{ bin_dir }}/step"
      - ""
      - "The download role should have installed this already."
      - ""
      - "Troubleshooting:"
      - "1. Ensure download role ran on this node"
      - "2. Check if download was skipped: ansible-playbook -vvv"
      - "3. Verify inventory groups are correct"
      - ""
      - "Manual installation:"
      - "   curl -L -o /tmp/step.tar.gz https://github.com/smallstep/cli/releases/download/v{{ step_version }}/step_linux_{{ step_version }}_amd64.tar.gz"
      - "   tar -xzf /tmp/step.tar.gz -C /tmp"
      - "   cp /tmp/step_{{ step_version }}/bin/step {{ bin_dir }}/step"
      - "   chmod 755 {{ bin_dir }}/step"
  when: not step_cli_installed.stat.exists

- name: Determine if this node needs client cert in separate directory
  set_fact:
    _use_client_cert_dir: "{{ inventory_hostname in groups[etcd_clients_group] }}"
    _client_cert_owner: "{{ etcd_client_cert_user if inventory_hostname in groups[etcd_clients_group] else etcd_user }}"

- name: Check if client certificate owner user exists
  command: id {{ _client_cert_owner.name }}
  register: cert_owner_check
  changed_when: false
  failed_when: false

- name: Display warning if user doesn't exist (fallback to etcd user)
  debug:
    msg:
      - "⚠️  WARNING: Client cert owner user '{{ _client_cert_owner.name }}' does not exist on {{ inventory_hostname }}"
      - ""
      - "Falling back to etcd user for client certificate ownership."
      - ""
      - "To fix: Create the user before deploying certificates"
  when: 
    - cert_owner_check.rc != 0
    - _use_client_cert_dir | bool

- name: Set certificate owner to etcd user if configured client user doesn't exist
  set_fact:
    _client_cert_owner: "{{ etcd_user }}"
  when: cert_owner_check.rc != 0

- name: Create /etc/etcd-client directory for client certificates
  file:
    path: "{{ etcd_client_cert_dir | dirname }}"
    state: directory
    owner: "{{ _client_cert_owner.name }}"
    group: "{{ _client_cert_owner.name }}"
    mode: 0700
  when: _use_client_cert_dir | bool

- name: Create client certificate directory
  file:
    path: "{{ etcd_client_cert_dir }}"
    state: directory
    owner: "{{ _client_cert_owner.name }}"
    group: "{{ _client_cert_owner.name }}"
    mode: 0700
  when: _use_client_cert_dir | bool

- name: Create step configuration directory for client certs
  file:
    path: "{{ etcd_client_cert_dir }}/.step"
    state: directory
    owner: "{{ _client_cert_owner.name }}"
    group: "{{ _client_cert_owner.name }}"
    mode: 0700
  when: _use_client_cert_dir | bool

- name: Create standard etcd cert directory (cluster nodes always need this)
  file:
    path: "{{ etcd_cert_dir }}"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Create step configuration directory for cluster nodes
  file:
    path: "{{ etcd_cert_dir }}/.step"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Fetch root CA certificate from cert-manager
  slurp:
    src: "{{ step_ca_certs }}/root_ca.crt"
  register: root_ca_from_certmanager
  delegate_to: "{{ groups[etcd_certmanagers_group][0] }}"
  run_once: false

- name: Install root CA certificate in client cert directory
  copy:
    content: "{{ root_ca_from_certmanager.content | b64decode }}"
    dest: "{{ etcd_client_cert_dir }}/root_ca.crt"
    owner: "{{ _client_cert_owner.name }}"
    group: "{{ _client_cert_owner.name }}"
    mode: 0400
  when: _use_client_cert_dir | bool

- name: Install root CA certificate in etcd cert directory (cluster nodes)
  copy:
    content: "{{ root_ca_from_certmanager.content | b64decode }}"
    dest: "{{ etcd_cert_dir }}/root_ca.crt"
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0400
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Wait for step-ca health endpoint
  uri:
    url: "{{ step_ca_url }}/health"
    validate_certs: no
    status_code: 200
  register: step_ca_health
  until: step_ca_health.status == 200
  retries: 30
  delay: 5
  when: not (ansible_check_mode | default(false) | bool)

- name: Test step-ca provisioner accessibility
  uri:
    url: "{{ step_ca_url }}/provisioners"
    validate_certs: no
    status_code: 200
  register: provisioners_check
  retries: 10
  delay: 5
  until: provisioners_check.status == 200
  failed_when: false
  when: not (ansible_check_mode | default(false) | bool)

- name: Display provisioner check result
  debug:
    msg:
      - "Provisioner endpoint status: {{ provisioners_check.status | default('NOT CHECKED') }}"
  when: provisioners_check is defined


- name: Get root CA fingerprint (from client cert dir)
  command: "{{ bin_dir }}/step certificate fingerprint {{ etcd_client_cert_dir }}/root_ca.crt"
  register: root_ca_fingerprint_client
  changed_when: false
  when: _use_client_cert_dir | bool

- name: Get root CA fingerprint (from etcd cert dir)
  command: "{{ bin_dir }}/step certificate fingerprint {{ etcd_cert_dir }}/root_ca.crt"
  register: root_ca_fingerprint_etcd
  changed_when: false
  when: inventory_hostname in groups[etcd_cluster_group]

- name: Bootstrap step CLI for client cert directory
  shell: >
    {{ bin_dir }}/step ca bootstrap
    --ca-url {{ step_ca_url }}
    --fingerprint {{ root_ca_fingerprint_client.stdout }}
    --install
    --force
  args:
    executable: /bin/bash
    creates: "{{ etcd_client_cert_dir }}/.step/config/defaults.json"
  environment:
    STEPPATH: "{{ etcd_client_cert_dir }}/.step"
  when: _use_client_cert_dir | bool
  register: bootstrap_result_client
  retries: 3
  delay: 15
  until: bootstrap_result_client.rc == 0
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Bootstrap step CLI for etcd cert directory (cluster nodes)
  shell: >
    {{ bin_dir }}/step ca bootstrap
    --ca-url {{ step_ca_url }}
    --fingerprint {{ root_ca_fingerprint_etcd.stdout }}
    --install
    --force
  args:
    executable: /bin/bash
    creates: "{{ etcd_cert_dir }}/.step/config/defaults.json"
  environment:
    STEPPATH: "{{ etcd_cert_dir }}/.step"
  when: inventory_hostname in groups[etcd_cluster_group]
  register: bootstrap_result_etcd
  retries: 3
  delay: 15
  until: bootstrap_result_etcd.rc == 0
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Set bootstrap result for error checking
  set_fact:
    bootstrap_result: "{{ bootstrap_result_client if _use_client_cert_dir | bool else bootstrap_result_etcd }}"

- name: Display bootstrap error if failed
  debug:
    msg:
      - "❌ Bootstrap failed after 3 retries"
      - ""
      - "Error: {{ bootstrap_result.stderr | default('No error message') }}"
      - ""
      - "Troubleshooting:"
      - "1. Check step-ca logs on cert-manager:"
      - "   ssh {{ step_ca_dns }} 'journalctl -u step-ca -n 100'"
      - ""
      - "2. Verify step-ca is running:"
      - "   curl -k {{ step_ca_url }}/health"
      - ""
      - "3. Check provisioner configuration:"
      - "   curl -k {{ step_ca_url }}/provisioners"
      - ""
      - "4. Verify root CA fingerprint matches:"
      - "   On cert-manager: step certificate fingerprint /etc/step-ca/certs/root_ca.crt"
      - "   On this node: step certificate fingerprint {{ etcd_client_cert_dir if _use_client_cert_dir | bool else etcd_cert_dir }}/root_ca.crt"
      - ""
      - "5. Check if root_ca.crt exists and is readable:"
      - "   ls -la {{ etcd_client_cert_dir if _use_client_cert_dir | bool else etcd_cert_dir }}/root_ca.crt"
  when: 
    - bootstrap_result is defined
    - bootstrap_result.rc != 0

- name: Fail if bootstrap failed
  fail:
    msg: "Bootstrap failed - see debug output above for troubleshooting steps"
  when:
    - bootstrap_result is defined
    - bootstrap_result.rc != 0

- name: Fix step configuration directory permissions for client cert dir
  file:
    path: "{{ etcd_client_cert_dir }}/.step"
    state: directory
    owner: "{{ _client_cert_owner.name }}"
    group: "{{ _client_cert_owner.name }}"
    mode: 0700
    recurse: yes
  when:
    - _use_client_cert_dir | bool
    - bootstrap_result_client is defined
    - bootstrap_result_client.rc == 0

- name: Fix step configuration directory permissions for cluster nodes
  file:
    path: "{{ etcd_cert_dir }}/.step"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700
    recurse: yes
  when:
    - inventory_hostname in groups[etcd_cluster_group]
    - bootstrap_result_etcd is defined
    - bootstrap_result_etcd.rc == 0

- name: Ensure /etc/etcd ownership is always etcd:etcd (cluster nodes)
  file:
    path: "{{ etcd_config_dir }}"
    state: directory
    owner: "{{ etcd_user.name }}"
    group: "{{ etcd_user.name }}"
    mode: 0700
  when: inventory_hostname in groups[etcd_cluster_group]
