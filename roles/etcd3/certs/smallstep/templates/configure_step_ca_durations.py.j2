#!/usr/bin/env python3
"""
Configure step-ca certificate duration claims
Generated by Ansible - do not edit manually
"""
import json
import sys

CONFIG_PATH = '{{ step_ca_config }}'
PROVISIONER_NAME = '{{ step_ca_provisioner }}'
MIN_DURATION = '{{ step_cert_min_duration }}'
MAX_DURATION = '{{ step_cert_max_duration }}'
DEFAULT_DURATION = '{{ step_cert_default_duration }}'

def main():
    # Read config
    try:
        with open(CONFIG_PATH, 'r') as f:
            config = json.load(f)
    except FileNotFoundError:
        print(f"Error: Config file not found: {CONFIG_PATH}", file=sys.stderr)
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON in config file: {e}", file=sys.stderr)
        sys.exit(1)
    
    # Update provisioner claims
    updated = False
    provisioners = config.get('authority', {}).get('provisioners', [])
    
    for provisioner in provisioners:
        if provisioner.get('name') == PROVISIONER_NAME:
            provisioner['claims'] = {
                'minTLSCertDuration': MIN_DURATION,
                'maxTLSCertDuration': MAX_DURATION,
                'defaultTLSCertDuration': DEFAULT_DURATION
            }
            updated = True
            break
    
    if not updated:
        print(f"Error: Provisioner '{PROVISIONER_NAME}' not found in config", file=sys.stderr)
        print(f"Available provisioners: {[p.get('name') for p in provisioners]}", file=sys.stderr)
        sys.exit(1)
    
    # Write updated config
    try:
        with open(CONFIG_PATH, 'w') as f:
            json.dump(config, f, indent=4)
        print(f"Successfully updated certificate durations for provisioner: {PROVISIONER_NAME}")
    except Exception as e:
        print(f"Error writing config file: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    main()
