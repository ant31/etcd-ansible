---
# Regenerate all certificates and CA (USE WITH CAUTION)
# This will:
# 1. Stop all etcd services
# 2. Delete existing CA and all certificates
# 3. Reinitialize step-ca with new passwords
# 4. Generate new certificates for all nodes
# 5. Restart etcd services
#
# Usage: ansible-playbook -i inventory.ini playbooks/regenerate-certs.yaml --vault-password-file ~/.vault-pass
#
# IMPORTANT: This will cause brief downtime while certificates are regenerated

- name: Confirm certificate regeneration
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Prompt for confirmation
      pause:
        prompt: |
          ⚠️  WARNING: CERTIFICATE REGENERATION
          
          This will:
          - Delete existing CA and all certificates
          - Stop all etcd services temporarily
          - Reinitialize step-ca with NEW passwords from vault.yml
          - Generate fresh certificates for all nodes
          
          Expected downtime: 5-10 minutes
          
          Have you updated vault.yml with NEW passwords? (yes/no)
      register: confirm_input
    
    - name: Validate confirmation
      assert:
        that:
          - confirm_input.user_input == 'yes'
        fail_msg: "Certificate regeneration cancelled"

- name: Cleanup old certificates and stop services
  hosts: etcd,etcd-clients,etcd-cert-managers
  become: yes
  gather_facts: yes
  serial: 1
  vars:
    cert_operation_action: regenerate
  roles:
    - role: etcd3/certs/operations
      tags:
        - regenerate

- name: Regenerate certificates with new CA
  hosts: etcd,etcd-clients,etcd-cert-managers
  become: yes
  gather_facts: yes
  vars:
    etcd_force_certs: true
  roles:
    - role: etcd3/certs/smallstep
      tags:
        - certs

- name: Restart etcd services
  hosts: etcd
  become: yes
  gather_facts: no
  serial: 1
  tasks:
    - name: Start etcd service
      systemd:
        name: "etcd-{{ etcd_cluster_name }}-{{ etcd_member_index | default(groups[etcd_cluster_group].index(inventory_hostname) + 1) }}"
        state: started
        enabled: yes
      register: etcd_start
      retries: 3
      delay: 10
      until: etcd_start is succeeded
    
    - name: Wait for node to be healthy
      command: >
        {{ bin_dir }}/etcdctl --endpoints=https://{{ ansible_default_ipv4.address }}:2379
        --cert={{ etcd_cert_paths.client.cert }}
        --cacert={{ etcd_cert_paths.client.ca }}
        --key={{ etcd_cert_paths.client.key }}
        endpoint health
      environment:
        ETCDCTL_API: "3"
      register: health_check
      retries: 10
      delay: 5
      until: health_check.rc == 0
      changed_when: false

- name: Verify cluster health
  hosts: etcd[0]
  become: yes
  gather_facts: no
  vars:
    operation_action: health
  roles:
    - role: etcd3/operations
      tags:
        - health

- name: Display completion status
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Show success message
      debug:
        msg: |
          ✅ Certificate regeneration complete!
          
          All certificates have been regenerated with new CA.
          Automatic renewal is configured via systemd timers.
          
          Next steps:
          1. Save new vault.yml passwords securely
          2. Update any external systems that use these certificates
          3. Verify cluster: ansible-playbook -i inventory.ini playbooks/etcd-health.yaml
